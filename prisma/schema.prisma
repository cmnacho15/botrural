generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String    @id @default(cuid())
  email                 String?   @unique
  name                  String?
  apellido              String? // ‚úÖ NUEVO - Para empleados sin email
  password              String?
  role                  Role      @default(COLABORADOR)
  accesoFinanzas        Boolean   @default(false) // ‚úÖ NUEVO
  campoId               String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  lastMessageAt         DateTime? @db.Timestamp(6)
  lastLoginAt           DateTime? @db.Timestamp(6) // üÜï √öltimo login web
  onboardingCompletedAt DateTime? @db.Timestamp(6)
  onboardingStartedAt   DateTime? @db.Timestamp(6)
  telefono              String?   @unique
  whatsappState         String?   @default("IDLE")

  // üîê SUSCRIPCI√ìN (para futura implementaci√≥n)
  subscriptionStatus String?   @default("TRIAL") // TRIAL, ACTIVE, EXPIRED, CANCELLED
  subscriptionPlan   String? // FREE, BASIC, PRO, ENTERPRISE
  trialEndsAt        DateTime?
  subscriptionEndsAt DateTime?

  accounts           Account[]
  eventos            Evento[]
  createdInvitations Invitation[]   @relation("CreatedInvitations")
  usedInvitations    Invitation[]   @relation("UsedInvitations")
  sessions           Session[]
  campo              Campo?         @relation(fields: [campoId], references: [id])
  campos             UsuarioCampo[]

  // üü¢ LADO INVERSO DE SnigUploadSession
  snigUploadSessions SnigUploadSession[]

  grupos UsuarioGrupo[]

  // üìä Consumo de IA
  aiUsage AIUsage[]

  // üìù Logs de actividad para admin
  activityLogs ActivityLog[]

  // üö® Logs de errores
  errorLogs ErrorLog[]

  // üìä Importaciones de gastos
  importacionesGastos ImportacionGastos[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Campo {
  id        String @id @default(cuid())
  nombre    String
  tipoCampo String @default("MIXTO") // "GANADERO" o "MIXTO"

  modoRodeo        String            @default("OPCIONAL") // ‚Üê AGREGAR ESTA L√çNEA
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  eventos          Evento[]
  gastos           Gasto[]
  importacionesGastos ImportacionGastos[]
  insumos          Insumo[]
  invitations      Invitation[]
  lotes            Lote[]
  usuarios         User[]
  usuariosCampo    UsuarioCampo[]
  modulosPastoreo  ModuloPastoreo[]
  manoObra         ManoObra[]
  tiposCultivo     TipoCultivo[]
  categoriasAnimal CategoriaAnimal[]
  categoriasGasto  CategoriaGasto[]

  firmas Firma[]

  rodeos Rodeo[]

  consumos Consumo[]

  inventarios Inventario[]

  // üü¢ NUEVA RELACI√ìN SNIG
  snigAnimales       SnigAnimal[]
  snigUploadSessions SnigUploadSession[]

  cargaHistorica CargaHistorica[]

  ventas Venta[]

  compras Compra[]

  actividadesCalendario ActividadCalendario[]

  trasladosOrigen  Traslado[] @relation("TrasladosOrigen")
  trasladosDestino Traslado[] @relation("TrasladosDestino")

  grupoId String?
  grupo   Grupo?  @relation(fields: [grupoId], references: [id])

  equivalenciasUG        EquivalenciaUG[]
  configRecategorizacion ConfigRecategorizacion?
  esquilas               Esquila[]
}

model CategoriaGasto {
  id        String   @id @default(cuid())
  nombre    String
  color     String
  campoId   String
  activo    Boolean  @default(true)
  orden     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campo Campo @relation(fields: [campoId], references: [id], onDelete: Cascade)

  @@unique([nombre, campoId])
  @@index([campoId])
}

model TipoCultivo {
  id        String   @id @default(cuid())
  nombre    String
  campoId   String
  campo     Campo    @relation(fields: [campoId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([nombre, campoId])
  @@index([campoId])
}

model CategoriaAnimal {
  id               String     @id @default(cuid())
  nombreSingular   String
  nombrePlural     String
  tipoAnimal       TipoAnimal
  campoId          String
  activo           Boolean    @default(true)
  esPredeterminado Boolean    @default(false)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  campo Campo @relation(fields: [campoId], references: [id], onDelete: Cascade)

  @@unique([nombreSingular, campoId])
  @@index([campoId])
}

enum TipoAnimal {
  BOVINO
  OVINO
  EQUINO
  OTRO
}

model Rodeo {
  id        String   @id @default(cuid())
  nombre    String
  campoId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campo   Campo    @relation(fields: [campoId], references: [id], onDelete: Cascade)
  eventos Evento[]

  @@unique([nombre, campoId])
  @@index([campoId])
}

model Lote {
  id               String   @id @default(cuid())
  nombre           String
  hectareas        Float
  poligono         Json?
  ultimoCambio     DateTime @default(now())
  esPastoreable    Boolean  @default(true) // üÜï NUEVO CAMPO
  campoId          String
  moduloPastoreoId String?

  trasladosDesde Traslado[] @relation("TrasladosDesdePotreros")
  trasladosHacia Traslado[] @relation("TrasladosHaciaPotreros")

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  animalesLote      AnimalLote[]
  cultivos          Cultivo[]
  eventos           Evento[]
  gastos            Gasto[]
  campo             Campo              @relation(fields: [campoId], references: [id], onDelete: Cascade)
  movimientosInsumo MovimientoInsumo[]
  cargaHistorica    CargaHistorica[]
  ndviImages        NDVIImage[] // üõ∞Ô∏è Im√°genes NDVI cacheadas
  altimetria        AltimetriaImage? // üèîÔ∏è Datos de altimetr√≠a (uno por lote)

  // üÜï AGREGAR ESTA RELACI√ìN
  moduloPastoreo ModuloPastoreo? @relation(fields: [moduloPastoreoId], references: [id], onDelete: SetNull)

  @@index([moduloPastoreoId]) // ‚Üê √≠ndice para b√∫squedas r√°pidas
  @@index([esPastoreable]) // üÜï √çNDICE para filtrar r√°pido
}

model Cultivo {
  id           String   @id @default(cuid())
  tipoCultivo  String
  fechaSiembra DateTime
  hectareas    Float
  loteId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lote         Lote     @relation(fields: [loteId], references: [id], onDelete: Cascade)
}

model AnimalLote {
  id           String   @id @default(cuid())
  categoria    String
  cantidad     Int
  peso         Float? // ‚úÖ NUEVO CAMPO (opcional)
  fechaIngreso DateTime @default(now())
  loteId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lote         Lote     @relation(fields: [loteId], references: [id], onDelete: Cascade)
  eventos      Evento[]

  ventasRenglones VentaRenglon[]

  consumosRenglones ConsumoRenglon[]
  comprasRenglones  CompraRenglon[]

  @@unique([loteId, categoria])
}

model Evento {
  id              String     @id @default(cuid())
  tipo            TipoEvento
  descripcion     String
  fecha           DateTime
  cantidad        Int?
  categoria       String?
  categoriaNueva  String?
  loteId          String?
  usuarioId       String?
  campoId         String
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  comprador       String?
  pagado          Boolean    @default(false)
  diasPlazo       Int?
  metodoPago      String?    @default("Contado")
  proveedor       String?
  iva             Float?
  monto           Float?
  animalLoteId    String?
  cantidadVendida Int?
  loteDestinoId   String?
  notas           String?
  caravana        String?
  intensidad      String?

  metadata Json? // ‚Üê AGREGAR ESTA L√çNEA
  imageUrl String? // URL de foto adjunta (observaciones de campo)

  rodeoId String?

  animalLote AnimalLote? @relation(fields: [animalLoteId], references: [id])
  campo      Campo       @relation(fields: [campoId], references: [id], onDelete: Cascade)
  lote       Lote?       @relation(fields: [loteId], references: [id])
  usuario    User?       @relation(fields: [usuarioId], references: [id])
  rodeo      Rodeo?      @relation(fields: [rodeoId], references: [id]) // ‚Üê AGREGAR ESTA L√çNEA

  caravanas  Json?
  origenSnig String?
}

model Insumo {
  id          String             @id @default(cuid())
  nombre      String
  unidad      String
  orden       Int                @default(0) // üëà AGREGAR ESTA L√çNEA
  campoId     String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  stock       Float              @default(0)
  campo       Campo              @relation(fields: [campoId], references: [id], onDelete: Cascade)
  movimientos MovimientoInsumo[]

  @@index([campoId, orden]) // üëà AGREGAR ESTA L√çNEA
}

model MovimientoInsumo {
  id        String   @id @default(cuid())
  tipo      String
  cantidad  Float
  fecha     DateTime
  notas     String?
  insumoId  String
  loteId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  insumo    Insumo   @relation(fields: [insumoId], references: [id], onDelete: Cascade)
  lote      Lote?    @relation(fields: [loteId], references: [id])
}

model Gasto {
  id              String    @id @default(cuid())
  tipo            String
  monto           Float // ‚ùå deprecated
  fecha           DateTime
  descripcion     String?
  categoria       String
  proveedor       String?
  comprador       String?
  metodoPago      String?
  diasPlazo       Int?
  pagado          Boolean   @default(true)
  fechaPago       DateTime?
  iva             Float?
  loteId          String?
  lote            Lote?     @relation(fields: [loteId], references: [id])
  campoId         String
  campo           Campo     @relation(fields: [campoId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  animalLoteId    String?
  cantidadVendida Int?

  imageUrl  String?
  imageName String?

  // üíµ CAMPOS DE MONEDA Y CONVERSI√ìN
  moneda        String
  montoOriginal Float
  tasaCambio    Float?
  montoEnUYU    Float
  montoEnUSD    Float // ‚úÖ NUEVO: valor hist√≥rico en USD

  // üêÑ ASIGNACI√ìN DE ESPECIE (para costos fijos)
  especie String? // ‚úÖ NUEVO: "VACUNOS" | "OVINOS" | "EQUINOS" | null

  // üè¢ GASTOS COMPARTIDOS ENTRE CAMPOS DEL MISMO GRUPO
  esGastoGrupo          Boolean @default(false) // üÜï
  grupoId               String? // üÜï
  montoTotalGrupo       Float? // üÜï monto original antes de distribuir
  porcentajeDistribuido Float? // üÜï % que corresponde a este campo

  // üìä IMPORTACI√ìN
  importacionId String?
  importacion   ImportacionGastos? @relation(fields: [importacionId], references: [id], onDelete: SetNull)

  @@index([campoId])
  @@index([fecha])
  @@index([tipo])
  @@index([especie]) // ‚úÖ √≠ndice para filtrar por especie
  @@index([grupoId]) // üÜï
  @@index([esGastoGrupo]) // üÜï
  @@index([importacionId]) // üìä
}

model Invitation {
  id          String         @id @default(dbgenerated("gen_random_uuid()"))
  token       String         @unique @default(cuid())
  role        InvitationRole // ‚úÖ CAMBIADO a enum espec√≠fico
  campoId     String
  campoIds    Json? // üëà AGREGAR ESTA L√çNEA
  createdById String
  usedById    String?
  expiresAt   DateTime       @db.Timestamptz(6)
  usedAt      DateTime?      @db.Timestamptz(6)
  createdAt   DateTime?      @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime?      @default(now()) @updatedAt @db.Timestamptz(6)
  campo       Campo          @relation(fields: [campoId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  createdBy   User           @relation("CreatedInvitations", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  usedBy      User?          @relation("UsedInvitations", fields: [usedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model PendingRegistration {
  telefono  String   @id
  token     String
  createdAt DateTime @default(now())
}

model PendingConfirmation {
  telefono  String   @id
  data      String
  createdAt DateTime @default(now())
}

model ManoObra {
  id                       String  @id @default(cuid())
  nombre                   String
  horas_trabajadas         Int     @default(0)
  dias_trabajados          Int     @default(0)
  dias_no_trabajados       Int     @default(0)
  feriados_trabajados      Int     @default(0)
  dias_descanso_trabajados Int     @default(0)
  faltas                   Int     @default(0)
  horas_extras             Int     @default(0)
  licencias                Int     @default(0)
  trabajo_feriado          Boolean @default(false)
  mes                      Int
  anio                     Int

  campoId String
  campo   Campo  @relation(fields: [campoId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ‚úÖ ENUM DE ROLES DE USUARIO
enum Role {
  MEGA_ADMIN // Super admin de la plataforma (solo nosotros)
  ADMIN_GENERAL // Primer usuario del campo, acceso total
  COLABORADOR // Acceso web + bot, finanzas opcional
  EMPLEADO // Solo bot, sin web
  CONTADOR // Solo lectura finanzas en web
}

// ‚úÖ ENUM DE TIPOS DE INVITACI√ìN
enum InvitationRole {
  COLABORADOR
  EMPLEADO
  CONTADOR
}

enum TipoEvento {
  NACIMIENTO
  MOVIMIENTO
  VENTA
  COMPRA
  TRASLADO
  MORTANDAD
  CONSUMO
  ABORTO
  DESTETE
  TACTO
  TRATAMIENTO
  RECATEGORIZACION
  RECATEGORIZACION_MASIVA // ‚Üê AGREGAR ESTA L√çNEA
  SIEMBRA
  PULVERIZACION
  REFERTILIZACION
  RIEGO
  MONITOREO
  COSECHA
  OTROS_LABORES
  LLUVIA
  HELADA
  USO_INSUMO
  INGRESO_INSUMO
  GASTO
  AJUSTE
  CAMBIO_POTRERO
  DAO // <-- AGREGAR ESTA L√çNEA
  MANEJO // Acciones f√≠sicas no sanitarias (quitar tablilla, se√±alar, etc.)
  OBSERVACION // Fotos de campo con comentarios

  SNIG_STOCK_INICIAL // ‚úÖ AGREGAR ESTOS
  SNIG_NACIMIENTO_CARAVANEO // ‚úÖ
  SNIG_COMPRA // ‚úÖ
  SNIG_VENTA // ‚úÖ
  SNIG_MORTANDAD // ‚úÖ
}

model SnigAnimal {
  id          String     @id @default(cuid())
  caravana    String
  estado      SnigEstado @default(EN_CAMPO)
  origen      SnigOrigen @default(DESCONOCIDO)
  fechaAlta   DateTime   @default(now())
  fechaBaja   DateTime?
  campoId     String
  sessionId   String?
  fechaEvento DateTime?
  meta        Json?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  session SnigUploadSession? @relation(fields: [sessionId], references: [id])
  campo   Campo              @relation(fields: [campoId], references: [id], onDelete: Cascade)

  @@unique([caravana, campoId])
  @@index([campoId])
  @@index([sessionId])
}

enum SnigEstado {
  EN_CAMPO
  VENDIDO
  MUERTO
}

enum SnigOrigen {
  STOCK_INICIAL
  NACIMIENTO
  COMPRA
  DESCONOCIDO
}

model SnigUploadSession {
  id            String   @id @default(cuid())
  campoId       String
  usuarioId     String?
  fechaSnig     DateTime
  cantidadTotal Int
  estado        String   @default("PENDIENTE")
  tipoDetectado String   @default("PENDIENTE")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  animales SnigAnimal[]
  campo    Campo        @relation(fields: [campoId], references: [id], onDelete: Cascade)
  usuario  User?        @relation(fields: [usuarioId], references: [id])

  @@index([campoId])
  @@index([estado])
}

model CargaHistorica {
  id        String   @id @default(cuid())
  fecha     DateTime @db.Date // Solo fecha, sin hora
  loteId    String
  ugTotal   Float
  campoId   String
  createdAt DateTime @default(now())

  lote  Lote  @relation(fields: [loteId], references: [id], onDelete: Cascade)
  campo Campo @relation(fields: [campoId], references: [id], onDelete: Cascade)

  @@unique([loteId, fecha]) // No puede haber dos snapshots del mismo potrero en la misma fecha
  @@index([campoId, loteId, fecha(sort: Desc)]) // B√∫squeda r√°pida del √∫ltimo snapshot
  @@index([campoId, fecha(sort: Desc)]) // B√∫squeda global por campo
}

model Inventario {
  id          String   @id @default(cuid())
  campoId     String
  fecha       DateTime
  categoria   String
  cantidad    Int
  peso        Float?
  precioKg    Float? // ‚Üê Este es el precio INICIO
  precioKgFin Float? // ‚Üê AGREGAR ESTE CAMPO (precio FIN)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campo Campo @relation(fields: [campoId], references: [id], onDelete: Cascade)

  @@unique([campoId, fecha, categoria])
  @@index([campoId, fecha])
}

// ==========================================
// üí∞ MODELOS DE VENTAS (agregar al final del schema)
// ==========================================

model Venta {
  id            String   @id @default(cuid())
  campoId       String
  tipoProducto  String? // "GANADO" | "LANA" | "GRANOS"
  fecha         DateTime
  comprador     String
  consignatario String? // quien vende/intermedia
  nroTropa      String?
  nroFactura    String?

  metodoPago       String    @default("Contado") // "Contado" | "Plazo"
  diasPlazo        Int?
  fechaVencimiento DateTime?
  pagado           Boolean   @default(false)

  moneda     String @default("USD") // "USD" | "UYU"
  tasaCambio Float? // si es UYU

  subtotalUSD       Float // suma de importes de renglones
  totalImpuestosUSD Float @default(0) // suma de todos los impuestos
  totalNetoUSD      Float // subtotal - impuestos

  firmaId String?

  // üìé ADJUNTAR BOLETA
  imageUrl  String? // URL de la boleta guardada
  imageName String? // nombre del archivo

  // üìä IMPUESTOS DESGLOSADOS (JSON)
  impuestos Json? // {mevir: 64.95, inia: 129.90, imeba: 649.49, ...}

  notas String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campo           Campo                @relation(fields: [campoId], references: [id], onDelete: Cascade)
  renglones       VentaRenglon[]
  serviciosGranos VentaGranoServicio[]
  serviciosGrano  ServicioGrano[]
  firma           Firma?               @relation(fields: [firmaId], references: [id])

  @@index([campoId])
  @@index([fecha])
  @@index([comprador])
  @@index([firmaId])
}

model VentaRenglon {
  id      String @id @default(cuid())
  ventaId String

  tipo       String  @default("GANADO") // "GANADO" | "LANA" | "GRANOS"
  tipoAnimal String // "BOVINO" | "OVINO" | "EQUINO" | "OTRO"
  categoria  String // "Vaca gorda", "Novillo gordo", "Ovejas", etc.
  raza       String? // "GEN S/Clasif", "HEREFORD"

  cantidad Int // n¬∫ de animales

  // üéÅ BONIFICACIONES Y DESCUENTOS
  esBonificacion Boolean @default(false) // true si es bonificaci√≥n/descuento
  rendimiento    Float? // % rendimiento frigor√≠fico (ej: 48.95)

  // üí∞ PRECIOS Y MONTOS (simplificado para el Excel)
  pesoPromedio    Float // kg/animal (peso/animal del Excel)
  precioKgUSD     Float // precio/kg (US$/kg del Excel)
  precioAnimalUSD Float // pesoPromedio * precioKgUSD
  pesoTotalKg     Float // cantidad * pesoPromedio
  importeBrutoUSD Float // pesoTotalKg * precioKgUSD

  // üè¶ DESCUENTO DE STOCK
  descontadoDeStock Boolean   @default(false) // si se descont√≥ del AnimalLote
  animalLoteId      String? // potrero del cual se descont√≥
  fechaDescuento    DateTime?

  // üêë CAMPOS PARA LANA (para futuro)
  esVentaLana      Boolean @default(false)
  kgVellon         Float?
  kgBarriga        Float?
  precioKgVellon   Float?
  precioKgBarriga  Float?
  numeroEsquilados Int?

  // üåæ CAMPOS ESPEC√çFICOS PARA GRANOS
  tipoCultivoNombre String? // "Trigo", "Soja", "Ma√≠z", etc.
  cantidadToneladas Decimal? @db.Decimal(10, 3) // 455.256 ton
  precioToneladaUSD Decimal? @db.Decimal(10, 4) // 182.0000 USD/ton
  kgRecibidos       Decimal? @db.Decimal(10, 2) // 466,260.00 (para liquidaciones)
  kgDescuentos      Decimal? @db.Decimal(10, 2) // -11,004.52 (para liquidaciones)
  kgNetosLiquidar   Decimal? @db.Decimal(10, 2) // 455,255.48 (para liquidaciones)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  venta      Venta       @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  animalLote AnimalLote? @relation(fields: [animalLoteId], references: [id])

  @@index([ventaId])
  @@index([animalLoteId])
}

model Consumo {
  id          String   @id @default(cuid())
  campoId     String
  fecha       DateTime
  descripcion String?
  notas       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campo     Campo            @relation(fields: [campoId], references: [id], onDelete: Cascade)
  renglones ConsumoRenglon[]

  @@index([campoId])
  @@index([fecha])
}

model ConsumoRenglon {
  id                String    @id @default(cuid())
  consumoId         String
  tipoAnimal        String
  categoria         String
  cantidad          Int
  pesoPromedio      Float?
  precioKgUSD       Float?
  precioAnimalUSD   Float?
  pesoTotalKg       Float?
  valorTotalUSD     Float?
  descontadoDeStock Boolean   @default(true)
  animalLoteId      String?
  fechaDescuento    DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  consumo    Consumo     @relation(fields: [consumoId], references: [id], onDelete: Cascade)
  animalLote AnimalLote? @relation(fields: [animalLoteId], references: [id])

  @@index([consumoId])
  @@index([animalLoteId])
}

// ==========================================
// üõí MODELOS DE COMPRAS
// ==========================================

model Compra {
  id            String   @id @default(cuid())
  campoId       String
  fecha         DateTime
  proveedor     String // ‚Üê CAMBIO: en vez de "comprador"
  consignatario String?
  nroTropa      String?
  nroFactura    String?

  firmaId String?

  metodoPago       String    @default("Contado")
  diasPlazo        Int?
  fechaVencimiento DateTime?
  pagado           Boolean   @default(false)

  moneda     String @default("USD")
  tasaCambio Float?

  subtotalUSD       Float
  totalImpuestosUSD Float @default(0)
  totalNetoUSD      Float

  imageUrl  String?
  imageName String?
  impuestos Json?
  notas     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campo     Campo           @relation(fields: [campoId], references: [id], onDelete: Cascade)
  renglones CompraRenglon[]

  firma Firma? @relation(fields: [firmaId], references: [id])

  @@index([campoId])
  @@index([fecha])
  @@index([proveedor])
  @@index([firmaId])
}

model CompraRenglon {
  id       String @id @default(cuid())
  compraId String

  tipoAnimal String // "BOVINO" | "OVINO" | "EQUINO" | "OTRO"
  categoria  String
  raza       String?
  cantidad   Int

  pesoPromedio    Float
  precioKgUSD     Float
  precioAnimalUSD Float
  pesoTotalKg     Float
  importeBrutoUSD Float

  // üè¶ INGRESO AL STOCK (en vez de descuento)
  agregarAlStock Boolean   @default(false) // ‚Üê CAMBIO: agregar en vez de descontar
  animalLoteId   String? // potrero al cual se agreg√≥
  fechaIngreso   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  compra     Compra      @relation(fields: [compraId], references: [id], onDelete: Cascade)
  animalLote AnimalLote? @relation(fields: [animalLoteId], references: [id])

  @@index([compraId])
  @@index([animalLoteId])
}

model ModuloPastoreo {
  id          String   @id @default(cuid())
  nombre      String
  descripcion String?
  campoId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campo Campo  @relation(fields: [campoId], references: [id], onDelete: Cascade)
  lotes Lote[]

  @@unique([nombre, campoId])
  @@index([campoId])
}

// ==========================================
// üìÖ CALENDARIO DE ACTIVIDADES
// ==========================================

model ActividadCalendario {
  id        String  @id @default(cuid())
  campoId   String
  usuarioId String?

  titulo           String
  fechaProgramada  DateTime  @db.Date
  realizada        Boolean   @default(false)
  fechaRealizacion DateTime?

  origen String  @default("WEB") // "WEB" | "WHATSAPP"
  notas  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campo Campo @relation(fields: [campoId], references: [id], onDelete: Cascade)

  @@index([campoId])
  @@index([fechaProgramada])
  @@index([realizada])
}

model Firma {
  id          String   @id @default(cuid())
  campoId     String
  rut         String
  razonSocial String
  esPrincipal Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campo   Campo    @relation(fields: [campoId], references: [id], onDelete: Cascade)
  ventas  Venta[]
  compras Compra[]

  @@unique([rut, campoId])
  @@index([campoId])
}

// ==========================================
// üë• RELACI√ìN USUARIO-CAMPO (Multi-campo)
// ==========================================

model UsuarioCampo {
  id        String   @id @default(cuid())
  userId    String
  campoId   String
  rol       Role     @default(COLABORADOR)
  esActivo  Boolean  @default(false) // Campo actualmente seleccionado en la sesi√≥n
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  campo Campo @relation(fields: [campoId], references: [id], onDelete: Cascade)

  @@unique([userId, campoId])
  @@index([userId])
  @@index([campoId])
}

// ==========================================
// üöö TRASLADOS ENTRE CAMPOS
// ==========================================

model Traslado {
  id    String   @id @default(cuid())
  fecha DateTime

  // Origen
  campoOrigenId   String
  potreroOrigenId String

  // Destino  
  campoDestinoId   String
  potreroDestinoId String

  // Animales
  tipoAnimal String // "BOVINO" | "OVINO"
  categoria  String
  cantidad   Int

  // Valoraci√≥n (opcional, editable)
  pesoPromedio    Float?
  precioKgUSD     Float?
  pesoTotalKg     Float? // calculado: cantidad * pesoPromedio
  precioAnimalUSD Float? // calculado: pesoPromedio * precioKgUSD
  totalUSD        Float? // calculado: cantidad * precioAnimalUSD

  // Stock
  stockDescontado Boolean @default(false)
  stockSumado     Boolean @default(false)

  notas String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  campoOrigen    Campo @relation("TrasladosOrigen", fields: [campoOrigenId], references: [id], onDelete: Cascade)
  campoDestino   Campo @relation("TrasladosDestino", fields: [campoDestinoId], references: [id], onDelete: Cascade)
  potreroOrigen  Lote  @relation("TrasladosDesdePotreros", fields: [potreroOrigenId], references: [id])
  potreroDestino Lote  @relation("TrasladosHaciaPotreros", fields: [potreroDestinoId], references: [id])

  @@index([campoOrigenId])
  @@index([campoDestinoId])
  @@index([fecha])
}

// ==========================================
// üè¢ GRUPOS (Empresas/Clientes)
// ==========================================

model Grupo {
  id        String   @id @default(cuid())
  nombre    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campos   Campo[]
  usuarios UsuarioGrupo[]
}

model UsuarioGrupo {
  id        String   @id @default(cuid())
  userId    String
  grupoId   String
  rol       Role     @default(COLABORADOR)
  esActivo  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  grupo Grupo @relation(fields: [grupoId], references: [id], onDelete: Cascade)

  @@unique([userId, grupoId])
  @@index([userId])
  @@index([grupoId])
}

// ==========================================
// ‚öñÔ∏è EQUIVALENCIAS UG PERSONALIZADAS
// ==========================================

model EquivalenciaUG {
  id        String @id @default(cuid())
  campoId   String
  categoria String // "Terneros", "Vacas", etc.
  pesoKg    Float // El peso que el usuario configura

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campo Campo @relation(fields: [campoId], references: [id], onDelete: Cascade)

  @@unique([campoId, categoria])
  @@index([campoId])
}

// ==========================================
// üîÑ RECATEGORIZACI√ìN AUTOM√ÅTICA
// ==========================================

model ConfigRecategorizacion {
  id      String @id @default(cuid())
  campoId String @unique

  bovinosActivo Boolean @default(false)
  bovinosDia    Int     @default(1)
  bovinosMes    Int     @default(1)

  ovinosActivo Boolean @default(false)
  ovinosDia    Int     @default(1)
  ovinosMes    Int     @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campo Campo @relation(fields: [campoId], references: [id], onDelete: Cascade)

  @@index([campoId])
}

// ==========================================
// üß∂ STOCK DE LANA
// ==========================================

model Esquila {
  id                String   @id @default(cuid())
  fecha             DateTime
  nroAnimales       Int
  notas             String?
  micras            Decimal? @db.Decimal(5, 1)
  rendimientoLavado Decimal? @db.Decimal(5, 2)
  campoId           String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  campo      Campo              @relation(fields: [campoId], references: [id], onDelete: Cascade)
  categorias EsquilaCategoria[]

  @@index([campoId])
  @@index([fecha])
}

model EsquilaCategoria {
  id          String   @id @default(cuid())
  esquilaId   String
  categoria   String
  pesoKg      Decimal  @db.Decimal(10, 2)
  precioUSD   Decimal  @db.Decimal(10, 2)
  pesoVendido Decimal  @default(0) @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  esquila Esquila @relation(fields: [esquilaId], references: [id], onDelete: Cascade)

  @@index([esquilaId])
  @@index([categoria])
}

// ==========================================
// üåæ SERVICIOS DE VENTAS DE GRANOS
// ==========================================

model VentaGranoServicio {
  id         String   @id @default(cuid())
  ventaId    String
  concepto   String // "Secado", "Flete", "Prelimpeza", "DAP-Flete", etc.
  importeUSD Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now())

  venta Venta @relation(fields: [ventaId], references: [id], onDelete: Cascade)

  @@index([ventaId])
}

model ServicioGrano {
  id             String   @id @default(cuid())
  ventaId        String
  cultivo        String
  loteId         String
  loteNombre     String
  hectareas      Float
  toneladas      Float
  precioTonelada Float
  precioTotalUSD Float
  createdAt      DateTime @default(now())

  venta Venta @relation(fields: [ventaId], references: [id], onDelete: Cascade)

  @@index([ventaId])
  @@index([loteId])
}

// ==========================================
// ü§ñ CONSUMO DE IA
// ==========================================

model AIUsage {
  id           String   @id @default(cuid())
  userId       String
  provider     String // "OPENAI" | "CLAUDE"
  model        String // "gpt-4o", "claude-3-sonnet", etc.
  feature      String // "FACTURA_PARSER", "BOT_RESPONSE", "VENTA_PARSER", etc.
  inputTokens  Int
  outputTokens Int
  totalTokens  Int
  costUSD      Float? // Costo estimado en USD
  metadata     Json? // Info adicional (ej: campoId, tipo de documento)
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([provider])
  @@index([feature])
  @@index([createdAt])
}

// ==========================================
// üí¨ MENSAJES DEL BOT WHATSAPP
// ==========================================

model BotMessage {
  id           String   @id @default(cuid())
  waId         String // WhatsApp ID del usuario
  telefono     String
  direction    String // "INBOUND" | "OUTBOUND"
  messageType  String // "TEXT", "IMAGE", "DOCUMENT", "AUDIO", etc.
  content      String?  @db.Text // Contenido del mensaje
  mediaUrl     String? // URL de media si aplica
  status       String? // "SENT", "DELIVERED", "READ", "FAILED"
  errorCode    String? // C√≥digo de error si fall√≥
  errorMessage String? // Mensaje de error
  responseTime Int? // Tiempo de respuesta en ms (para outbound)
  aiTokensUsed Int? // Tokens de IA usados para esta respuesta
  metadata     Json? // Info adicional
  createdAt    DateTime @default(now())

  @@index([waId])
  @@index([telefono])
  @@index([direction])
  @@index([createdAt])
  @@index([status])
}

// ==========================================
// üìù LOGS DE ACTIVIDAD (ADMIN)
// ==========================================

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String?
  campoId   String?
  action    String // "LOGIN", "CREATE_VENTA", "DELETE_GASTO", "IMPERSONATE", etc.
  entity    String? // "Venta", "Gasto", "Evento", etc.
  entityId  String? // ID del objeto afectado
  details   Json? // Detalles adicionales
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([campoId])
  @@index([action])
  @@index([createdAt])
}

// ==========================================
// üõ∞Ô∏è IM√ÅGENES NDVI (Cache de im√°genes satelitales)
// ==========================================

model NDVIImage {
  id         String   @id @default(cuid())
  loteId     String
  imagenUrl  String // URL p√∫blica en Supabase Storage
  imagenDate DateTime // Fecha de la imagen satelital
  scale      String   @default("dynamic") // "fixed" o "dynamic"
  minNdvi    Float?
  maxNdvi    Float?
  avgNdvi    Float?
  cloudIndex Float? // √çndice de nubosidad
  bbox       Json? // Bounding box [west, south, east, north]
  width      Int?
  height     Int?
  fileSize   Int? // Tama√±o en bytes
  source     String   @default("Sentinel-2") // Fuente de datos
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  lote Lote @relation(fields: [loteId], references: [id], onDelete: Cascade)

  @@index([loteId])
  @@index([imagenDate])
  @@index([loteId, scale])
}

// ==========================================
// üèîÔ∏è ALTIMETR√çA (Cache de datos de elevaci√≥n)
// ==========================================

model AltimetriaImage {
  id        String @id @default(cuid())
  loteId    String @unique // Un registro por lote (no cambia)

  // üìä Estad√≠sticas de elevaci√≥n
  elevacionMin      Float // Metros sobre nivel del mar
  elevacionMax      Float
  elevacionPromedio Float
  rangoElevacion    Float // max - min

  // üìê Estad√≠sticas de pendiente
  pendientePromedio Float? // En grados
  pendienteMax      Float?

  // üñºÔ∏è URLs en Supabase Storage
  heatmapUrl   String? // PNG del mapa de elevaci√≥n
  slopeUrl     String? // PNG del mapa de pendientes
  aspectUrl    String? // PNG del mapa de drenaje/aspecto

  // üìç Curvas de nivel (GeoJSON)
  curvasNivel Json? // Array de LineString con propiedad elevation

  // üì¶ Metadata
  bbox           Json?  // Bounding box [west, south, east, north]
  width          Int?
  height         Int?
  resolucionM    Float  @default(30) // Resoluci√≥n en metros
  fuente         String @default("Copernicus GLO-30")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lote Lote @relation(fields: [loteId], references: [id], onDelete: Cascade)

  @@index([loteId])
}

// ==========================================
// üö® LOGS DE ERRORES (Para monitoreo de clientes)
// ==========================================

model ErrorLog {
  id        String   @id @default(cuid())
  userId    String?
  campoId   String?

  // üìç Contexto del error
  source    String   // "WEB", "WHATSAPP", "API", "CRON"
  level     String   @default("ERROR") // "ERROR", "WARNING", "CRITICAL"

  // üìù Detalles del error
  message   String   // Mensaje de error principal
  stack     String?  // Stack trace si existe
  context   Json?    // Datos adicionales (p√°gina, acci√≥n, etc.)

  // üîß Metadata t√©cnica
  userAgent String?
  url       String?  // URL donde ocurri√≥ (para web)

  // üìß Estado de notificaci√≥n
  emailSent Boolean  @default(false)
  resolved  Boolean  @default(false)
  resolvedAt DateTime?
  resolvedBy String?  // ID del admin que lo resolvi√≥
  notes     String?   // Notas del admin

  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([campoId])
  @@index([source])
  @@index([level])
  @@index([resolved])
  @@index([createdAt])
}

// ==========================================
// üìä IMPORTACIONES DE GASTOS
// ==========================================

model ImportacionGastos {
  id               String   @id @default(cuid())
  campoId          String
  usuarioId        String
  nombreArchivo    String
  totalFilas       Int
  filasImportadas  Int
  filasConError    Int
  errores          Json?    // Array de errores por fila
  estado           String   @default("COMPLETADA") // COMPLETADA, REVERTIDA
  createdAt        DateTime @default(now())

  campo   Campo @relation(fields: [campoId], references: [id], onDelete: Cascade)
  usuario User  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  gastos  Gasto[]

  @@index([campoId])
  @@index([usuarioId])
  @@index([createdAt])
}
