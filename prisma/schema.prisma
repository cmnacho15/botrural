generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String    @id @default(cuid())
  email                 String?   @unique
  name                  String?
  password              String?
  role                  Role      @default(USUARIO)
  campoId               String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  lastMessageAt         DateTime? @db.Timestamp(6)
  onboardingCompletedAt DateTime? @db.Timestamp(6)
  onboardingStartedAt   DateTime? @db.Timestamp(6)
  telefono              String?   @unique
  whatsappState         String?   @default("IDLE")
  accounts              Account[]
  eventos               Evento[]
  createdInvitations    Invitation[] @relation("CreatedInvitations")
  usedInvitations       Invitation[] @relation("UsedInvitations")
  sessions              Session[]
  campo                 Campo?    @relation(fields: [campoId], references: [id])
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String    @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Campo {
  id         String     @id @default(cuid())
  nombre     String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  eventos    Evento[]
  gastos     Gasto[]
  insumos    Insumo[]
  invitations Invitation[]
  lotes      Lote[]
  usuarios   User[]
}

model Lote {
  id               String           @id @default(cuid())
  nombre           String
  hectareas        Float
  poligono         Json?
  campoId          String
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  animalesLote     AnimalLote[]
  cultivos         Cultivo[]
  eventos          Evento[]
  gastos           Gasto[]
  campo            Campo            @relation(fields: [campoId], references: [id], onDelete: Cascade)
  movimientosInsumo MovimientoInsumo[]
}

model Cultivo {
  id           String   @id @default(cuid())
  tipoCultivo  String
  fechaSiembra DateTime
  hectareas    Float
  loteId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lote         Lote     @relation(fields: [loteId], references: [id], onDelete: Cascade)
}

model AnimalLote {
  id           String   @id @default(cuid())
  categoria    String
  cantidad     Int
  fechaIngreso DateTime @default(now())
  loteId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lote         Lote     @relation(fields: [loteId], references: [id], onDelete: Cascade)
  eventos      Evento[]
}

model Evento {
  id              String     @id @default(cuid())
  tipo            TipoEvento
  descripcion     String
  fecha           DateTime
  cantidad        Int?
  categoria       String?
  loteId          String?
  usuarioId       String
  campoId         String
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  comprador       String?
  pagado          Boolean    @default(false)
  diasPlazo       Int?
  metodoPago      String?    @default("Contado")
  proveedor       String?
  iva             Float?
  monto           Float?
  animalLoteId    String?
  cantidadVendida Int?
  animalLote      AnimalLote? @relation(fields: [animalLoteId], references: [id])

  campo           Campo       @relation(fields: [campoId], references: [id], onDelete: Cascade)
  lote            Lote?       @relation(fields: [loteId], references: [id])
  usuario         User        @relation(fields: [usuarioId], references: [id])
}

model Insumo {
  id        String   @id @default(cuid())
  nombre    String
  unidad    String
  campoId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  stock     Float    @default(0)
  campo     Campo    @relation(fields: [campoId], references: [id], onDelete: Cascade)
  movimientos MovimientoInsumo[]
}

model MovimientoInsumo {
  id        String   @id @default(cuid())
  tipo      String
  cantidad  Float
  fecha     DateTime
  notas     String?
  insumoId  String
  loteId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  insumo    Insumo   @relation(fields: [insumoId], references: [id], onDelete: Cascade)
  lote      Lote?    @relation(fields: [loteId], references: [id])
}

model Gasto {
  id              String    @id @default(cuid())
  tipo            String
  monto           Float
  fecha           DateTime
  descripcion     String?
  categoria       String
  proveedor       String?
  comprador       String?
  metodoPago      String?
  diasPlazo       Int?
  pagado          Boolean   @default(true)
  fechaPago       DateTime?
  iva             Float?
  loteId          String?
  lote            Lote?     @relation(fields: [loteId], references: [id])
  campoId         String
  campo           Campo     @relation(fields: [campoId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // âœ… NUEVOS CAMPOS AGREGADOS
  animalLoteId    String?
  cantidadVendida Int?

  @@index([campoId])
  @@index([fecha])
  @@index([tipo])
}

model Invitation {
  id          String    @id @default(dbgenerated("gen_random_uuid()"))
  token       String    @unique @default(cuid())
  role        String
  campoId     String
  createdById String
  usedById    String?
  expiresAt   DateTime  @db.Timestamptz(6)
  usedAt      DateTime? @db.Timestamptz(6)
  createdAt   DateTime? @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime? @default(now()) @updatedAt @db.Timestamptz(6)
  campo       Campo     @relation(fields: [campoId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  createdBy   User      @relation("CreatedInvitations", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  usedBy      User?     @relation("UsedInvitations", fields: [usedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model ManoObra {
  id                      String   @id @default(cuid())
  nombre                  String
  horas_trabajadas        Int      @default(0)
  dias_trabajados         Int      @default(0)
  dias_no_trabajados      Int      @default(0)
  feriados_trabajados     Int      @default(0)
  dias_descanso_trabajados Int     @default(0)
  faltas                  Int      @default(0)
  horas_extras            Int      @default(0)
  licencias               Int      @default(0)

  mes                     Int
  anio                    Int

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

enum Role {
  ADMIN
  USUARIO
}

enum TipoEvento {
  NACIMIENTO
  MOVIMIENTO
  VENTA
  COMPRA
  TRASLADO
  MORTANDAD
  CONSUMO
  ABORTO
  DESTETE
  TACTO
  TRATAMIENTO
  RECATEGORIZACION
  SIEMBRA
  PULVERIZACION
  REFERTILIZACION
  RIEGO
  MONITOREO
  COSECHA
  OTROS_LABORES
  LLUVIA
  HELADA
  USO_INSUMO
  INGRESO_INSUMO
  GASTO
}