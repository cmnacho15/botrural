generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String       @id @default(cuid())
  email                 String?      @unique
  name                  String?
  apellido              String? // ✅ NUEVO - Para empleados sin email
  password              String?
  role                  Role         @default(COLABORADOR)
  accesoFinanzas        Boolean      @default(false) // ✅ NUEVO
  campoId               String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  lastMessageAt         DateTime?    @db.Timestamp(6)
  onboardingCompletedAt DateTime?    @db.Timestamp(6)
  onboardingStartedAt   DateTime?    @db.Timestamp(6)
  telefono              String?      @unique
  whatsappState         String?      @default("IDLE")
  accounts              Account[]
  eventos               Evento[]
  createdInvitations    Invitation[] @relation("CreatedInvitations")
  usedInvitations       Invitation[] @relation("UsedInvitations")
  sessions              Session[]
  campo                 Campo?       @relation(fields: [campoId], references: [id])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Campo {
  id          String       @id @default(cuid())
  nombre      String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  eventos     Evento[]
  gastos      Gasto[]
  insumos     Insumo[]
  invitations Invitation[]
  lotes       Lote[]
  usuarios    User[]
  manoObra    ManoObra[]
  tiposCultivo TipoCultivo[]
  categoriasAnimal CategoriaAnimal[] // ← AGREGAR ESTA LÍNEA
}

model TipoCultivo {
  id        String   @id @default(cuid())
  nombre    String
  campoId   String
  campo     Campo    @relation(fields: [campoId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([nombre, campoId])
  @@index([campoId])
}

model CategoriaAnimal {
  id               String   @id @default(cuid())
  nombreSingular   String
  nombrePlural     String
  tipoAnimal       TipoAnimal
  campoId          String
  activo           Boolean  @default(true)
  esPredeterminado Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  campo Campo @relation(fields: [campoId], references: [id], onDelete: Cascade)
  
  @@unique([nombreSingular, campoId])
  @@index([campoId])
}

enum TipoAnimal {
  BOVINO
  OVINO
  EQUINO
  OTRO
}

model Lote {
  id                String             @id @default(cuid())
  nombre            String
  hectareas         Float
  poligono          Json?
  ultimoCambio      DateTime           @default(now())
  campoId           String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  animalesLote      AnimalLote[]
  cultivos          Cultivo[]
  eventos           Evento[]
  gastos            Gasto[]
  campo             Campo              @relation(fields: [campoId], references: [id], onDelete: Cascade)
  movimientosInsumo MovimientoInsumo[]
}

model Cultivo {
  id           String   @id @default(cuid())
  tipoCultivo  String
  fechaSiembra DateTime
  hectareas    Float
  loteId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lote         Lote     @relation(fields: [loteId], references: [id], onDelete: Cascade)
}

model AnimalLote {
  id           String   @id @default(cuid())
  categoria    String
  cantidad     Int
  fechaIngreso DateTime @default(now())
  loteId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lote         Lote     @relation(fields: [loteId], references: [id], onDelete: Cascade)
  eventos      Evento[]
}

model Evento {
  id              String      @id @default(cuid())
  tipo            TipoEvento
  descripcion     String
  fecha           DateTime
  cantidad        Int?
  categoria       String?
  categoriaNueva  String?
  loteId          String?
  usuarioId       String?     // ✅ AGREGAR "?" ACÁ
  campoId         String
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  comprador       String?
  pagado          Boolean     @default(false)
  diasPlazo       Int?
  metodoPago      String?     @default("Contado")
  proveedor       String?
  iva             Float?
  monto           Float?
  animalLoteId    String?
  cantidadVendida Int?
  loteDestinoId   String?
  notas           String?
  intensidad      String?
  
  animalLote      AnimalLote? @relation(fields: [animalLoteId], references: [id])
  campo           Campo       @relation(fields: [campoId], references: [id], onDelete: Cascade)
  lote            Lote?       @relation(fields: [loteId], references: [id])
  usuario         User?       @relation(fields: [usuarioId], references: [id])  // ✅ AGREGAR "?" ACÁ TAMBIÉN
}

model Insumo {
  id          String             @id @default(cuid())
  nombre      String
  unidad      String
  campoId     String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  stock       Float              @default(0)
  campo       Campo              @relation(fields: [campoId], references: [id], onDelete: Cascade)
  movimientos MovimientoInsumo[]
}

model MovimientoInsumo {
  id        String   @id @default(cuid())
  tipo      String
  cantidad  Float
  fecha     DateTime
  notas     String?
  insumoId  String
  loteId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  insumo    Insumo   @relation(fields: [insumoId], references: [id], onDelete: Cascade)
  lote      Lote?    @relation(fields: [loteId], references: [id])
}

model Gasto {
  id              String    @id @default(cuid())
  tipo            String
  monto           Float
  fecha           DateTime
  descripcion     String?
  categoria       String
  proveedor       String?
  comprador       String?
  metodoPago      String?
  diasPlazo       Int?
  pagado          Boolean   @default(true)
  fechaPago       DateTime?
  iva             Float?
  loteId          String?
  lote            Lote?     @relation(fields: [loteId], references: [id])
  campoId         String
  campo           Campo     @relation(fields: [campoId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  animalLoteId    String?
  cantidadVendida Int?
  
  // ✨ NUEVOS CAMPOS PARA FACTURAS
  imageUrl        String?   // URL pública de Supabase Storage
  imageName       String?   // Path del archivo en el bucket

  @@index([campoId])
  @@index([fecha])
  @@index([tipo])
}

model Invitation {
  id          String         @id @default(dbgenerated("gen_random_uuid()"))
  token       String         @unique @default(cuid())
  role        InvitationRole // ✅ CAMBIADO a enum específico
  campoId     String
  createdById String
  usedById    String?
  expiresAt   DateTime       @db.Timestamptz(6)
  usedAt      DateTime?      @db.Timestamptz(6)
  createdAt   DateTime?      @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime?      @default(now()) @updatedAt @db.Timestamptz(6)
  campo       Campo          @relation(fields: [campoId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  createdBy   User           @relation("CreatedInvitations", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  usedBy      User?          @relation("UsedInvitations", fields: [usedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model PendingRegistration {
  telefono  String   @id
  token     String
  createdAt DateTime @default(now())
}

model PendingConfirmation {
  telefono  String   @id
  data      String
  createdAt DateTime @default(now())
}

model ManoObra {
  id                       String  @id @default(cuid())
  nombre                   String
  horas_trabajadas         Int     @default(0)
  dias_trabajados          Int     @default(0)
  dias_no_trabajados       Int     @default(0)
  feriados_trabajados      Int     @default(0)
  dias_descanso_trabajados Int     @default(0)
  faltas                   Int     @default(0)
  horas_extras             Int     @default(0)
  licencias                Int     @default(0)
  trabajo_feriado          Boolean @default(false)
  mes                      Int
  anio                     Int

  campoId String
  campo   Campo  @relation(fields: [campoId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ✅ ENUM DE ROLES DE USUARIO
enum Role {
  ADMIN_GENERAL // Primer usuario, acceso total
  COLABORADOR // Acceso web + bot, finanzas opcional
  EMPLEADO // Solo bot, sin web
  CONTADOR // Solo lectura finanzas en web
}

// ✅ ENUM DE TIPOS DE INVITACIÓN
enum InvitationRole {
  COLABORADOR
  EMPLEADO
  CONTADOR
}

enum TipoEvento {
  NACIMIENTO
  MOVIMIENTO
  VENTA
  COMPRA
  TRASLADO
  MORTANDAD
  CONSUMO
  ABORTO
  DESTETE
  TACTO
  TRATAMIENTO
  RECATEGORIZACION
  SIEMBRA
  PULVERIZACION
  REFERTILIZACION
  RIEGO
  MONITOREO
  COSECHA
  OTROS_LABORES
  LLUVIA
  HELADA
  USO_INSUMO
  INGRESO_INSUMO
  GASTO
  AJUSTE
  CAMBIO_POTRERO
}
