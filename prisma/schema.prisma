generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String       @id @default(cuid())
  email                 String?      @unique
  name                  String?
  apellido              String? // ‚úÖ NUEVO - Para empleados sin email
  password              String?
  role                  Role         @default(COLABORADOR)
  accesoFinanzas        Boolean      @default(false) // ‚úÖ NUEVO
  campoId               String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  lastMessageAt         DateTime?    @db.Timestamp(6)
  onboardingCompletedAt DateTime?    @db.Timestamp(6)
  onboardingStartedAt   DateTime?    @db.Timestamp(6)
  telefono              String?      @unique
  whatsappState         String?      @default("IDLE")
  accounts              Account[]
  eventos               Evento[]
  createdInvitations    Invitation[] @relation("CreatedInvitations")
  usedInvitations       Invitation[] @relation("UsedInvitations")
  sessions              Session[]
  campo                 Campo?       @relation(fields: [campoId], references: [id])
  
  // üü¢ LADO INVERSO DE SnigUploadSession
  snigUploadSessions    SnigUploadSession[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Campo {
  id          String       @id @default(cuid())
  nombre      String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  eventos     Evento[]
  gastos      Gasto[]
  insumos     Insumo[]
  invitations Invitation[]
  lotes       Lote[]
  usuarios    User[]
  manoObra    ManoObra[]
  tiposCultivo TipoCultivo[]
  categoriasAnimal CategoriaAnimal[] // ‚Üê AGREGAR ESTA L√çNEA
  categoriasGasto CategoriaGasto[]

  consumos Consumo[]

  inventarios Inventario[]

  // üü¢ NUEVA RELACI√ìN SNIG
  snigAnimales     SnigAnimal[]
  snigUploadSessions SnigUploadSession[]

  cargaHistorica   CargaHistorica[]

  ventas Venta[]

}

model CategoriaGasto {
  id        String   @id @default(cuid())
  nombre    String
  color     String
  campoId   String
  activo    Boolean  @default(true)
  orden     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  campo Campo @relation(fields: [campoId], references: [id], onDelete: Cascade)
  
  @@unique([nombre, campoId])
  @@index([campoId])
}

model TipoCultivo {
  id        String   @id @default(cuid())
  nombre    String
  campoId   String
  campo     Campo    @relation(fields: [campoId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([nombre, campoId])
  @@index([campoId])
}

model CategoriaAnimal {
  id               String   @id @default(cuid())
  nombreSingular   String
  nombrePlural     String
  tipoAnimal       TipoAnimal
  campoId          String
  activo           Boolean  @default(true)
  esPredeterminado Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  campo Campo @relation(fields: [campoId], references: [id], onDelete: Cascade)
  
  @@unique([nombreSingular, campoId])
  @@index([campoId])
}

enum TipoAnimal {
  BOVINO
  OVINO
  EQUINO
  OTRO
}

model Lote {
  id                String             @id @default(cuid())
  nombre            String
  hectareas         Float
  poligono          Json?
  ultimoCambio      DateTime           @default(now())
  campoId           String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  animalesLote      AnimalLote[]
  cultivos          Cultivo[]
  eventos           Evento[]
  gastos            Gasto[]
  campo             Campo              @relation(fields: [campoId], references: [id], onDelete: Cascade)
  movimientosInsumo MovimientoInsumo[]
  cargaHistorica    CargaHistorica[]
}

model Cultivo {
  id           String   @id @default(cuid())
  tipoCultivo  String
  fechaSiembra DateTime
  hectareas    Float
  loteId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lote         Lote     @relation(fields: [loteId], references: [id], onDelete: Cascade)
}

model AnimalLote {
  id           String   @id @default(cuid())
  categoria    String
  cantidad     Int
  peso         Float?   // ‚úÖ NUEVO CAMPO (opcional)
  fechaIngreso DateTime @default(now())
  loteId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lote         Lote     @relation(fields: [loteId], references: [id], onDelete: Cascade)
  eventos      Evento[]

  @@unique([loteId, categoria])

  ventasRenglones VentaRenglon[]

  consumosRenglones ConsumoRenglon[]

}

model Evento {
  id              String      @id @default(cuid())
  tipo            TipoEvento
  descripcion     String
  fecha           DateTime
  cantidad        Int?
  categoria       String?
  categoriaNueva  String?
  loteId          String?
  usuarioId       String?     // ‚úÖ AGREGAR "?" AC√Å
  campoId         String
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  comprador       String?
  pagado          Boolean     @default(false)
  diasPlazo       Int?
  metodoPago      String?     @default("Contado")
  proveedor       String?
  iva             Float?
  monto           Float?
  animalLoteId    String?
  cantidadVendida Int?
  loteDestinoId   String?
  notas           String?
  intensidad      String?
  
  animalLote      AnimalLote? @relation(fields: [animalLoteId], references: [id])
  campo           Campo       @relation(fields: [campoId], references: [id], onDelete: Cascade)
  lote            Lote?       @relation(fields: [loteId], references: [id])
  usuario         User?       @relation(fields: [usuarioId], references: [id])  // ‚úÖ AGREGAR "?" AC√Å TAMBI√âN

    caravanas   Json?        // ‚Üê lista de caravanas involucradas (venta, compra, mortandad)
  origenSnig  String?      // "BOT" | "WEB" | null
}

model Insumo {
  id          String             @id @default(cuid())
  nombre      String
  unidad      String
  orden       Int                @default(0)  // üëà AGREGAR ESTA L√çNEA
  campoId     String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  stock       Float              @default(0)
  campo       Campo              @relation(fields: [campoId], references: [id], onDelete: Cascade)
  movimientos MovimientoInsumo[]

  @@index([campoId, orden])  // üëà AGREGAR ESTA L√çNEA
}

model MovimientoInsumo {
  id        String   @id @default(cuid())
  tipo      String
  cantidad  Float
  fecha     DateTime
  notas     String?
  insumoId  String
  loteId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  insumo    Insumo   @relation(fields: [insumoId], references: [id], onDelete: Cascade)
  lote      Lote?    @relation(fields: [loteId], references: [id])
}

model Gasto {
  id              String    @id @default(cuid())
  tipo            String
  monto           Float            // ‚ùå LO VAMOS A DEJAR POR COMPATIBILIDAD (pero ya no se usa para c√°lculos)
  fecha           DateTime
  descripcion     String?
  categoria       String
  proveedor       String?
  comprador       String?
  metodoPago      String?
  diasPlazo       Int?
  pagado          Boolean   @default(true)
  fechaPago       DateTime?
  iva             Float?
  loteId          String?
  lote            Lote?     @relation(fields: [loteId], references: [id])
  campoId         String
  campo           Campo     @relation(fields: [campoId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  animalLoteId    String?
  cantidadVendida Int?

  // ‚ú® NUEVOS CAMPOS PARA FACTURAS
  imageUrl        String?
  imageName       String?

  // üíµ NUEVOS CAMPOS PARA MONEDA Y CONVERSI√ìN
  moneda        String     // "USD" | "UYU"
  montoOriginal Float      // Tal cual aparece en la factura
  tasaCambio    Float?     // Si moneda = "USD" ‚Üí tasa del d√≠a; si "UYU" = null
  montoEnUYU    Float      // montoOriginal * tasaCambio o montoOriginal si es en UYU

  @@index([campoId])
  @@index([fecha])
  @@index([tipo])
}

model Invitation {
  id          String         @id @default(dbgenerated("gen_random_uuid()"))
  token       String         @unique @default(cuid())
  role        InvitationRole // ‚úÖ CAMBIADO a enum espec√≠fico
  campoId     String
  createdById String
  usedById    String?
  expiresAt   DateTime       @db.Timestamptz(6)
  usedAt      DateTime?      @db.Timestamptz(6)
  createdAt   DateTime?      @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime?      @default(now()) @updatedAt @db.Timestamptz(6)
  campo       Campo          @relation(fields: [campoId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  createdBy   User           @relation("CreatedInvitations", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  usedBy      User?          @relation("UsedInvitations", fields: [usedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model PendingRegistration {
  telefono  String   @id
  token     String
  createdAt DateTime @default(now())
}

model PendingConfirmation {
  telefono  String   @id
  data      String
  createdAt DateTime @default(now())
}

model ManoObra {
  id                       String  @id @default(cuid())
  nombre                   String
  horas_trabajadas         Int     @default(0)
  dias_trabajados          Int     @default(0)
  dias_no_trabajados       Int     @default(0)
  feriados_trabajados      Int     @default(0)
  dias_descanso_trabajados Int     @default(0)
  faltas                   Int     @default(0)
  horas_extras             Int     @default(0)
  licencias                Int     @default(0)
  trabajo_feriado          Boolean @default(false)
  mes                      Int
  anio                     Int

  campoId String
  campo   Campo  @relation(fields: [campoId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ‚úÖ ENUM DE ROLES DE USUARIO
enum Role {
  ADMIN_GENERAL // Primer usuario, acceso total
  COLABORADOR // Acceso web + bot, finanzas opcional
  EMPLEADO // Solo bot, sin web
  CONTADOR // Solo lectura finanzas en web
}

// ‚úÖ ENUM DE TIPOS DE INVITACI√ìN
enum InvitationRole {
  COLABORADOR
  EMPLEADO
  CONTADOR
}

enum TipoEvento {
  NACIMIENTO
  MOVIMIENTO
  VENTA
  COMPRA
  TRASLADO
  MORTANDAD
  CONSUMO
  ABORTO
  DESTETE
  TACTO
  TRATAMIENTO
  RECATEGORIZACION
  SIEMBRA
  PULVERIZACION
  REFERTILIZACION
  RIEGO
  MONITOREO
  COSECHA
  OTROS_LABORES
  LLUVIA
  HELADA
  USO_INSUMO
  INGRESO_INSUMO
  GASTO
  AJUSTE
  CAMBIO_POTRERO
  
  SNIG_STOCK_INICIAL           // ‚úÖ AGREGAR ESTOS
  SNIG_NACIMIENTO_CARAVANEO    // ‚úÖ
  SNIG_COMPRA                  // ‚úÖ
  SNIG_VENTA                   // ‚úÖ
  SNIG_MORTANDAD              // ‚úÖ
}

model SnigAnimal {
  id          String     @id @default(cuid())
  caravana    String
  estado      SnigEstado @default(EN_CAMPO)
  origen      SnigOrigen @default(DESCONOCIDO)
  fechaAlta   DateTime   @default(now())
  fechaBaja   DateTime?
  campoId     String
  sessionId   String?
  fechaEvento DateTime?
  meta        Json?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  session SnigUploadSession? @relation(fields: [sessionId], references: [id])
  campo   Campo              @relation(fields: [campoId], references: [id], onDelete: Cascade)

  @@unique([caravana, campoId])
  @@index([campoId])
  @@index([sessionId])
}

enum SnigEstado {
  EN_CAMPO
  VENDIDO
  MUERTO
}

enum SnigOrigen {
  STOCK_INICIAL
  NACIMIENTO
  COMPRA
  DESCONOCIDO
}

model SnigUploadSession {
  id            String       @id @default(cuid())
  campoId       String
  usuarioId     String?
  fechaSnig     DateTime
  cantidadTotal Int
  estado        String       @default("PENDIENTE")
  tipoDetectado String       @default("PENDIENTE")
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  animales  SnigAnimal[]
  campo     Campo    @relation(fields: [campoId], references: [id], onDelete: Cascade)
  usuario   User?    @relation(fields: [usuarioId], references: [id])
  
  @@index([campoId])
  @@index([estado])
}

model CargaHistorica {
  id        String   @id @default(cuid())
  fecha     DateTime @db.Date // Solo fecha, sin hora
  loteId    String
  ugTotal   Float
  campoId   String
  createdAt DateTime @default(now())

  lote  Lote  @relation(fields: [loteId], references: [id], onDelete: Cascade)
  campo Campo @relation(fields: [campoId], references: [id], onDelete: Cascade)

  @@unique([loteId, fecha]) // No puede haber dos snapshots del mismo potrero en la misma fecha
  @@index([campoId, loteId, fecha(sort: Desc)]) // B√∫squeda r√°pida del √∫ltimo snapshot
  @@index([campoId, fecha(sort: Desc)]) // B√∫squeda global por campo
}

model Inventario {
  id         String   @id @default(cuid())
  campoId    String
  fecha      DateTime
  categoria  String
  cantidad   Int
  peso       Float?
  precioKg   Float?      // ‚Üê Este es el precio INICIO
  precioKgFin Float?     // ‚Üê AGREGAR ESTE CAMPO (precio FIN)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  campo Campo @relation(fields: [campoId], references: [id], onDelete: Cascade)
  
  @@unique([campoId, fecha, categoria])
  @@index([campoId, fecha])
}








// ==========================================
// üí∞ MODELOS DE VENTAS (agregar al final del schema)
// ==========================================

model Venta {
  id                String    @id @default(cuid())
  campoId           String
  fecha             DateTime
  comprador         String
  consignatario     String?   // quien vende/intermedia
  nroTropa          String?
  nroFactura        String?
  
  metodoPago        String    @default("Contado")  // "Contado" | "Plazo"
  diasPlazo         Int?
  fechaVencimiento  DateTime?
  pagado            Boolean   @default(false)
  
  moneda            String    @default("USD")  // "USD" | "UYU"
  tasaCambio        Float?    // si es UYU
  
  subtotalUSD       Float     // suma de importes de renglones
  totalImpuestosUSD Float     @default(0) // suma de todos los impuestos
  totalNetoUSD      Float     // subtotal - impuestos
  
  // üìé ADJUNTAR BOLETA
  imageUrl          String?   // URL de la boleta guardada
  imageName         String?   // nombre del archivo
  
  // üìä IMPUESTOS DESGLOSADOS (JSON)
  impuestos         Json?     // {mevir: 64.95, inia: 129.90, imeba: 649.49, ...}
  
  notas             String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  campo             Campo     @relation(fields: [campoId], references: [id], onDelete: Cascade)
  renglones         VentaRenglon[]
  
  @@index([campoId])
  @@index([fecha])
  @@index([comprador])
}

model VentaRenglon {
  id                      String   @id @default(cuid())
  ventaId                 String
  
  tipo                    String   @default("GANADO")  // "GANADO" | "LANA"
  tipoAnimal              String   // "BOVINO" | "OVINO" | "EQUINO" | "OTRO"
  categoria               String   // "Vaca gorda", "Novillo gordo", "Ovejas", etc.
  raza                    String?  // "GEN S/Clasif", "HEREFORD"
  
  cantidad                Int      // n¬∫ de animales
  
  // üí∞ PRECIOS Y MONTOS (simplificado para el Excel)
  pesoPromedio            Float    // kg/animal (peso/animal del Excel)
  precioKgUSD             Float    // precio/kg (US$/kg del Excel)
  precioAnimalUSD         Float    // pesoPromedio * precioKgUSD
  pesoTotalKg             Float    // cantidad * pesoPromedio
  importeBrutoUSD         Float    // pesoTotalKg * precioKgUSD
  
  // üè¶ DESCUENTO DE STOCK
  descontadoDeStock       Boolean  @default(false)  // si se descont√≥ del AnimalLote
  animalLoteId            String?  // potrero del cual se descont√≥
  fechaDescuento          DateTime?
  
  // üêë CAMPOS PARA LANA (para futuro)
  esVentaLana             Boolean  @default(false)
  kgVellon                Float?
  kgBarriga               Float?
  precioKgVellon          Float?
  precioKgBarriga         Float?
  numeroEsquilados        Int?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  venta                   Venta      @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  animalLote              AnimalLote? @relation(fields: [animalLoteId], references: [id])
  
  @@index([ventaId])
  @@index([animalLoteId])
}









model Consumo {
  id          String    @id @default(cuid())
  campoId     String
  fecha       DateTime
  descripcion String?
  notas       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  campo       Campo     @relation(fields: [campoId], references: [id], onDelete: Cascade)
  renglones   ConsumoRenglon[]
  
  @@index([campoId])
  @@index([fecha])
}

model ConsumoRenglon {
  id                String   @id @default(cuid())
  consumoId         String
  tipoAnimal        String
  categoria         String
  cantidad          Int
  pesoPromedio      Float?
  precioKgUSD       Float?
  precioAnimalUSD   Float?
  pesoTotalKg       Float?
  valorTotalUSD     Float?
  descontadoDeStock Boolean  @default(true)
  animalLoteId      String?
  fechaDescuento    DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  consumo           Consumo      @relation(fields: [consumoId], references: [id], onDelete: Cascade)
  animalLote        AnimalLote? @relation(fields: [animalLoteId], references: [id])
  
  @@index([consumoId])
  @@index([animalLoteId])
}