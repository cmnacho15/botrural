# üìã CATEGOR√çAS DE ANIMALES - Gu√≠a Completa

## üéØ ¬øQu√© son las Categor√≠as de Animales?

Las **Categor√≠as de Animales** son las clasificaciones que us√°s en todo el sistema para referirte a tipos espec√≠ficos de animales (Vacas, Toros, Novillos, Ovejas, etc.).

### ¬øPor qu√© son importantes?

1. **C√°lculo de UG (Unidades Ganaderas)**: Cada categor√≠a tiene una equivalencia espec√≠fica en UG
2. **Consistencia en el sistema**: Se usan en modales, reportes, filtros, estad√≠sticas
3. **Agrupaci√≥n**: Permiten agrupar animales por tipo en reportes y dashboards

---

## üèóÔ∏è Arquitectura del Sistema

### 1Ô∏è‚É£ **Definici√≥n Central** (`src/lib/constants.ts`)
```typescript
import { TipoAnimal } from '@prisma/client'

export const CATEGORIAS_ANIMALES_DEFAULT = [
  // BOVINOS
  { nombreSingular: 'Toros', nombrePlural: 'Toros', tipoAnimal: TipoAnimal.BOVINO },
  { nombreSingular: 'Vacas', nombrePlural: 'Vacas', tipoAnimal: TipoAnimal.BOVINO },
  { nombreSingular: 'Novillos +3 a√±os', nombrePlural: 'Novillos +3 a√±os', tipoAnimal: TipoAnimal.BOVINO },
  { nombreSingular: 'Novillos 2‚Äì3 a√±os', nombrePlural: 'Novillos 2‚Äì3 a√±os', tipoAnimal: TipoAnimal.BOVINO },
  { nombreSingular: 'Novillos 1‚Äì2 a√±os', nombrePlural: 'Novillos 1‚Äì2 a√±os', tipoAnimal: TipoAnimal.BOVINO },
  { nombreSingular: 'Vaquillonas +2 a√±os', nombrePlural: 'Vaquillonas +2 a√±os', tipoAnimal: TipoAnimal.BOVINO },
  { nombreSingular: 'Vaquillonas 1‚Äì2 a√±os', nombrePlural: 'Vaquillonas 1‚Äì2 a√±os', tipoAnimal: TipoAnimal.BOVINO },
  { nombreSingular: 'Terneros', nombrePlural: 'Terneros', tipoAnimal: TipoAnimal.BOVINO },
  { nombreSingular: 'Terneras', nombrePlural: 'Terneras', tipoAnimal: TipoAnimal.BOVINO },
  { nombreSingular: 'Terneros nacidos', nombrePlural: 'Terneros nacidos', tipoAnimal: TipoAnimal.BOVINO },
  
  // OVINOS
  { nombreSingular: 'Carneros', nombrePlural: 'Carneros', tipoAnimal: TipoAnimal.OVINO },
  { nombreSingular: 'Ovejas', nombrePlural: 'Ovejas', tipoAnimal: TipoAnimal.OVINO },
  { nombreSingular: 'Capones', nombrePlural: 'Capones', tipoAnimal: TipoAnimal.OVINO },
  { nombreSingular: 'Borregas 2‚Äì4 dientes', nombrePlural: 'Borregas 2‚Äì4 dientes', tipoAnimal: TipoAnimal.OVINO },
  { nombreSingular: 'Corderas DL', nombrePlural: 'Corderas DL', tipoAnimal: TipoAnimal.OVINO },
  { nombreSingular: 'Corderos DL', nombrePlural: 'Corderos DL', tipoAnimal: TipoAnimal.OVINO },
  { nombreSingular: 'Corderos/as Mamones', nombrePlural: 'Corderos/as Mamones', tipoAnimal: TipoAnimal.OVINO },
  
  // EQUINOS
  { nombreSingular: 'Padrillos', nombrePlural: 'Padrillos', tipoAnimal: TipoAnimal.EQUINO },
  { nombreSingular: 'Yeguas', nombrePlural: 'Yeguas', tipoAnimal: TipoAnimal.EQUINO },
  { nombreSingular: 'Caballos', nombrePlural: 'Caballos', tipoAnimal: TipoAnimal.EQUINO },
  { nombreSingular: 'Potrillos', nombrePlural: 'Potrillos', tipoAnimal: TipoAnimal.EQUINO },
] as const
```

**‚úÖ Este es el √öNICO lugar donde defin√≠s las categor√≠as predeterminadas que se crean autom√°ticamente.**

---

### 2Ô∏è‚É£ **Creaci√≥n Autom√°tica en Registro**

Cuando un usuario se registra (`/api/register`), se crean autom√°ticamente:
```typescript
// 4. Crear categor√≠as de animales predeterminadas
await tx.categoriaAnimal.createMany({
  data: CATEGORIAS_ANIMALES_DEFAULT.map(cat => ({
    nombreSingular: cat.nombreSingular,
    nombrePlural: cat.nombrePlural,
    tipoAnimal: cat.tipoAnimal,
    campoId: campo.id,
    activo: true,
    esPredeterminado: true,
  })),
  skipDuplicates: true,
})
```

**Resultado**: El nuevo usuario ya tiene todas las categor√≠as en su campo.

---

### 3Ô∏è‚É£ **API de Gesti√≥n** (`/api/categorias-animal/route.ts`)

Esta API permite gestionar las categor√≠as de animales de forma din√°mica.

#### üìñ **GET** - Obtener categor√≠as de un campo
```typescript
// USO NORMAL (con sesi√≥n)
fetch('/api/categorias-animal')

// USO ESPECIAL (para SNIG, sin sesi√≥n)
fetch('/api/categorias-animal?campoId=xyz')
```

**D√≥nde se usa:**
- ‚úÖ **Modales** (Nacimiento, Mortandad, Recategorizaci√≥n, Venta, Compra, Consumo, etc.)
- ‚úÖ **SNIG** (necesita campoId por par√°metro porque no hay sesi√≥n)
- ‚úÖ **Filtros en Datos** (DatosContext carga las categor√≠as activas)
- ‚úÖ **Dropdowns en formularios**

#### ‚ûï **POST** - Crear categor√≠a personalizada
```typescript
fetch('/api/categorias-animal', {
  method: 'POST',
  body: JSON.stringify({
    nombreSingular: 'Vaquillas +1 a√±o',
    nombrePlural: 'Vaquillas +1 a√±o',
    tipoAnimal: 'BOVINO'
  })
})
```

**D√≥nde se usa:**
- ‚úÖ P√°gina de **Preferencias** (cuando el usuario crea una categor√≠a custom)

#### üîÑ **PATCH** - Activar/Desactivar categor√≠a
```typescript
fetch('/api/categorias-animal', {
  method: 'PATCH',
  body: JSON.stringify({
    id: 'abc123',
    activo: false
  })
})
```

**D√≥nde se usa:**
- ‚úÖ P√°gina de **Preferencias** (toggle on/off de categor√≠as)

**Nota importante:** Las categor√≠as desactivadas NO aparecen en:
- Dropdowns de modales
- Filtros de la p√°gina Datos
- Nuevos eventos

Pero **S√ç siguen funcionando** para eventos hist√≥ricos.

---

## üî¢ C√°lculo de UG (Unidades Ganaderas)

### Archivo: `src/lib/ugCalculator.ts`
```typescript
export const EQUIVALENCIAS_UG: Record<string, number> = {
  // üêÑ VACUNOS
  'Toros': 1.20,
  'Vacas': 1.00,
  'Novillos +3 a√±os': 1.20,
  'Novillos 2‚Äì3 a√±os': 1.00,
  'Novillos 1‚Äì2 a√±os': 0.70,
  'Vaquillonas +2 a√±os': 1.00,
  'Vaquillonas 1‚Äì2 a√±os': 0.70,
  'Terneros': 0.40,
  'Terneras': 0.40,
  'Terneros nacidos': 0,  // No cuentan en UG (equivalencia especial)
  
  // üêë OVINOS
  'Carneros': 0.17,
  'Ovejas': 0.16,
  'Capones': 0.14,
  'Borregas 2‚Äì4 dientes': 0.16,
  'Corderas DL': 0.10,
  'Corderos DL': 0.10,
  'Corderos/as Mamones': 0.10,

  // üê¥ YEGUARIZOS
  'Padrillos': 1.20,
  'Yeguas': 1.20,
  'Caballos': 1.20,
  'Potrillos': 1.20,
}

/**
 * Calcula las UG de las vacas considerando terneros nacidos
 * üÜï L√ìGICA ESPECIAL: Vacas con ternero nacido = 1.2 UG
 */
function calcularUGVacas(animales: Animal[]): number {
  const ternerosNacidos = animales.find(a => a.categoria === 'Terneros nacidos')?.cantidad || 0
  const vacasTotal = animales.find(a => a.categoria === 'Vacas')?.cantidad || 0
  const vacasConCria = Math.min(ternerosNacidos, vacasTotal)
  const vacasSinCria = Math.max(0, vacasTotal - ternerosNacidos)
  return (vacasConCria * 1.2) + (vacasSinCria * 1.0)
}

/**
 * Calcula las UG totales de una lista de animales
 * üÜï L√ìGICA ESPECIAL: Si hay "Terneros nacidos", las vacas equivalentes valen 1.2 UG
 */
export function calcularUGTotales(animales: Animal[]): number {
  if (!animales || animales.length === 0) return 0

  let ugTotales = 0
  
  // 1Ô∏è‚É£ Calcular UG de vacas con l√≥gica especial
  const ugVacas = calcularUGVacas(animales)
  ugTotales += ugVacas

  // 2Ô∏è‚É£ Calcular UG del resto de animales (excepto vacas)
  for (const animal of animales) {
    if (animal.categoria === 'Vacas') {
      continue  // Ya las contamos arriba
    }
    
    const equivalencia = EQUIVALENCIAS_UG[animal.categoria] || 0
    ugTotales += animal.cantidad * equivalencia
  }

  return ugTotales
}
```

**D√≥nde se usa:**
- ‚úÖ `/dashboard/lotes` - Carga global y por potrero
- ‚úÖ `/dashboard/indicadores` - Gr√°ficos de UG
- ‚úÖ `/dashboard/ug-evolution` - Evoluci√≥n hist√≥rica
- ‚úÖ `/api/dashboard-data` - Res√∫menes

**‚ö†Ô∏è Importante:** Las categor√≠as en `EQUIVALENCIAS_UG` deben coincidir EXACTAMENTE con las de `CATEGORIAS_ANIMALES_DEFAULT`.

---

## üìÇ Archivos que Usan Categor√≠as

### **Modales (todos en `/src/app/components/modales/`)**

| Modal | Uso |
|-------|-----|
| `ModalNacimiento.tsx` | Dropdown con categor√≠as especiales ("Terneros nacidos" / "Corderos/as Mamones") |
| `ModalMortandad.tsx` | Fetch categor√≠as activas ‚Üí dropdown "Categor√≠a afectada" |
| `ModalRecategorizacion.tsx` | Fetch categor√≠as activas ‚Üí "De" y "A" |
| `ModalVenta.tsx` | Fetch categor√≠as activas ‚Üí renglones de venta |
| `ModalCompra.tsx` | Fetch categor√≠as activas ‚Üí renglones de compra |
| `ModalConsumo.tsx` | Fetch categor√≠as activas ‚Üí renglones de consumo |
| `ModalTacto.tsx` | Fetch categor√≠as activas ‚Üí dropdown |
| `ModalTratamiento.tsx` | Fetch categor√≠as activas ‚Üí dropdown |

**Patr√≥n com√∫n:**
```typescript
const { data: categorias = [] } = useSWR('/api/categorias-animal', fetcher)

// Luego en el dropdown:
<select>
  {categorias
    .filter(c => c.tipoAnimal === 'BOVINO' && c.activo)
    .map(cat => (
      <option key={cat.id} value={cat.nombreSingular}>
        {cat.nombreSingular}
      </option>
    ))
  }
</select>
```

---

### **P√°ginas**

| P√°gina | Uso |
|--------|-----|
| `/dashboard/lotes` | Muestra animales agrupados por categor√≠a con badges |
| `/dashboard/datos` | Carga categor√≠as activas para filtros + b√∫squeda |
| `/dashboard/indicadores` | Gr√°ficos por categor√≠a |
| `/dashboard/preferencias` | CRUD completo de categor√≠as (crear, activar/desactivar) |
| `/dashboard/snig` | Fetch con `?campoId=` para confirmar importaci√≥n |

---

### **APIs**

| API | Uso |
|-----|-----|
| `/api/eventos` | Valida que la categor√≠a existe y actualiza stock de animales |
| `/api/ventas` | Valida categor√≠as en renglones y descuenta stock |
| `/api/compras` | Valida categor√≠as en renglones e incrementa stock |
| `/api/consumos` | Valida categor√≠as en renglones y descuenta stock |
| `/api/datos` | Retorna eventos con campo `categoriaAnimal` para filtros |

---

### **Contexto de Datos** (`/app/contexts/DatosContext.tsx`)

Este contexto es cr√≠tico para el funcionamiento de los filtros en la p√°gina de Datos.

**Carga categor√≠as activas al montar:**
```typescript
useEffect(() => {
  fetch('/api/categorias-animal')
    .then(r => r.json())
    .then(categorias => {
      const activas = categorias
        .filter((c: any) => c.activo)
        .map((c: any) => c.nombreSingular)
      setCategoriasActivas(activas)
    })
}, [])
```

**Agrupaci√≥n de categor√≠as para matching flexible:**
```typescript
const AGRUPACION_ANIMALES: Record<string, string[]> = {
  'Novillos': ['Novillos +3 a√±os', 'Novillos 2‚Äì3 a√±os', 'Novillos 1‚Äì2 a√±os', 'Novillos'],
  'Vaquillonas': ['Vaquillonas +2 a√±os', 'Vaquillonas 1‚Äì2 a√±os', 'Vaquillonas'],
  'Terneros': ['Terneros'],
  'Terneras': ['Terneras'],
  'Terneros nacidos': ['Terneros nacidos'],
  'Corderos/as Mamones': ['Corderos/as Mamones'],
  // ... m√°s categor√≠as
}
```

**Filtro inteligente de animales:**
- Busca tanto en `dato.categoriaAnimal` (campo espec√≠fico del evento)
- Como en `dato.descripcion` (texto descriptivo)
- Soporta eventos especiales como recategorizaci√≥n (busca en origen Y destino)

---

## ‚ûï C√≥mo Agregar una Nueva Categor√≠a Predeterminada

### **Paso 1: Agregar en `constants.ts`**
```typescript
export const CATEGORIAS_ANIMALES_DEFAULT = [
  // ... categor√≠as existentes ...
  
  // üÜï NUEVA
  { 
    nombreSingular: 'Terneros destetados', 
    nombrePlural: 'Terneros destetados', 
    tipoAnimal: TipoAnimal.BOVINO 
  },
] as const
```

### **Paso 2: Agregar equivalencia UG en `ugCalculator.ts`**
```typescript
export const EQUIVALENCIAS_UG: Record<string, number> = {
  // ... equivalencias existentes ...
  
  // üÜï NUEVA
  'Terneros destetados': 0.50,
}
```

**Y actualizar los arrays de categor√≠as en las funciones:**
```typescript
// En calcularEstadisticasLote() y calcularEstadisticasCampo()
if (['Toros', 'Novillos +3 a√±os', 'Novillos 2‚Äì3 a√±os', 
     'Novillos 1‚Äì2 a√±os', 'Vaquillonas +2 a√±os', 'Vaquillonas 1‚Äì2 a√±os', 
     'Terneros', 'Terneras', 'Terneros nacidos', 'Terneros destetados'].includes(animal.categoria)) {  // üÜï AGREGAR
  desglosePorTipo.vacunos += ugAnimal
}

// En calcularRelacionLanarVacuno()
const categoriasVacunas = ['Toros', 'Vacas', 'Novillos +3 a√±os', 'Novillos 2‚Äì3 a√±os', 
                           'Novillos 1‚Äì2 a√±os', 'Vaquillonas +2 a√±os', 'Vaquillonas 1‚Äì2 a√±os', 
                           'Terneros', 'Terneras', 'Terneros nacidos', 'Terneros destetados']  // üÜï AGREGAR
```

### **Paso 3: Agregar en DatosContext (si aplica)**

Si quer√©s que la nueva categor√≠a tenga agrupaci√≥n especial en filtros:
```typescript
const AGRUPACION_ANIMALES: Record<string, string[]> = {
  // ... existentes ...
  'Terneros destetados': ['Terneros destetados'],  // üÜï AGREGAR
}
```

### **Paso 4: Correr script para usuarios existentes**
```bash
npx tsx scripts/add-new-categorias.ts
```

**‚úÖ LISTO** - Nuevos usuarios ya la tienen, usuarios viejos tambi√©n.

---

## üîÑ Migrar una Categor√≠a Existente (Ejemplo: Terneros/as ‚Üí Terneros + Terneras)

Si necesit√°s **dividir** o **cambiar** categor√≠as existentes, segu√≠ este proceso:

### **Paso 1: Crear script de migraci√≥n**
```typescript
// scripts/migrate-terneros-categoria.ts
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function main() {
  const campos = await prisma.campo.findMany({
    include: {
      categoriasAnimal: true,
      lotes: true
    }
  })

  for (const campo of campos) {
    // 1. Crear nuevas categor√≠as
    await prisma.categoriaAnimal.createMany({
      data: [
        { nombreSingular: 'Terneros', nombrePlural: 'Terneros', tipoAnimal: 'BOVINO', campoId: campo.id, activo: true, esPredeterminado: true },
        { nombreSingular: 'Terneras', nombrePlural: 'Terneras', tipoAnimal: 'BOVINO', campoId: campo.id, activo: true, esPredeterminado: true }
      ],
      skipDuplicates: true
    })

    // 2. Migrar datos de AnimalesLote (dividir 50/50)
    const animalesLote = await prisma.animalLote.findMany({
      where: { 
        loteId: { in: campo.lotes.map(l => l.id) },
        categoria: 'Terneros/as'
      }
    })

    for (const animal of animalesLote) {
      const mitad = Math.floor(animal.cantidad / 2)
      const resto = animal.cantidad % 2

      await prisma.animalLote.create({
        data: { loteId: animal.loteId, categoria: 'Terneros', cantidad: mitad + resto, peso: animal.peso, fechaIngreso: animal.fechaIngreso }
      })

      await prisma.animalLote.create({
        data: { loteId: animal.loteId, categoria: 'Terneras', cantidad: mitad, peso: animal.peso, fechaIngreso: animal.fechaIngreso }
      })

      await prisma.animalLote.delete({ where: { id: animal.id } })
    }

    // 3. Actualizar Eventos
    await prisma.evento.updateMany({
      where: { campoId: campo.id, categoria: 'Terneros/as' },
      data: { categoria: 'Terneros' }
    })

    // 4. Actualizar Ventas, Compras, Consumos...
    // (Similar al punto 3)

    // 5. Desactivar categor√≠a antigua
    const categoriaAntigua = campo.categoriasAnimal.find(c => c.nombreSingular === 'Terneros/as')
    if (categoriaAntigua) {
      await prisma.categoriaAnimal.update({
        where: { id: categoriaAntigua.id },
        data: { activo: false }
      })
    }
  }
}

main()
  .catch(console.error)
  .finally(() => prisma.$disconnect())
```

### **Paso 2: Ejecutar migraci√≥n**
```bash
npx tsx scripts/migrate-terneros-categoria.ts
```

---

## üóëÔ∏è ¬øSe Puede Borrar `/api/categorias-animal`?

### ‚ùå **NO, ES CR√çTICO**

Esta API se usa en:

1. ‚úÖ **Todos los modales** (18+ componentes)
2. ‚úÖ **SNIG** (importaci√≥n de animales)
3. ‚úÖ **Preferencias** (CRUD de categor√≠as)
4. ‚úÖ **Filtros en Datos** (DatosContext)
5. ‚úÖ **Validaci√≥n en APIs de eventos**

**Sin esta API, TODO el sistema de animales se rompe.**

---

## üîß C√≥mo Funciona el Sistema Completo

### **Flujo de Registro de Usuario Nuevo**
```
1. Usuario se registra ‚Üí /api/register
2. Se crea Campo ‚Üí campo.id = 'abc123'
3. Se crean 23 categor√≠as de animales con campoId = 'abc123'
   (Bovinos: 10, Ovinos: 7, Equinos: 4)
4. Usuario entra al dashboard ‚Üí Fetch /api/categorias-animal
5. Aparecen en todos los dropdowns y modales
```

---

### **Flujo de C√°lculo de UG con Terneros Nacidos**
```
1. Usuario tiene animales en potrero:
   - 10 Vacas
   - 5 Terneros nacidos
   
2. Se llama calcularUGTotales([
     { categoria: 'Vacas', cantidad: 10 },
     { categoria: 'Terneros nacidos', cantidad: 5 }
   ])
   
3. L√≥gica especial:
   - 5 Vacas tienen cr√≠a = 5 * 1.2 = 6.0 UG
   - 5 Vacas sin cr√≠a = 5 * 1.0 = 5.0 UG
   - Terneros nacidos = 5 * 0 = 0 UG (no cuentan, ya est√°n en las vacas)
   - TOTAL = 11.0 UG
   
4. Carga UG/ha:
   - Potrero tiene 10 hect√°reas
   - 11.0 UG / 10 ha = 1.10 UG/ha ‚úÖ Verde (√≥ptimo)
```

---

### **Flujo de Filtrado en P√°gina Datos**
```
1. Usuario filtra por "Terneros nacidos"
2. DatosContext verifica:
   - ¬ø"Terneros nacidos" est√° en categoriasActivas? ‚úÖ S√≠
3. Para cada evento:
   - Verifica dato.categoriaAnimal === "Terneros nacidos" ‚úÖ
   - O busca "Terneros nacidos" en dato.descripcion
4. Muestra eventos que coinciden
```

---

## üé® Colores de Carga UG

En `/dashboard/lotes` se muestra con colores:
```typescript
const color = 
  cargaUG < 0.7 ? 'bg-blue-100 text-blue-700'    // Baja
  : cargaUG <= 1.5 ? 'bg-green-100 text-green-700' // √ìptima ‚úÖ
  : cargaUG <= 2.0 ? 'bg-orange-100 text-orange-700' // Alta ‚ö†Ô∏è
  : 'bg-red-100 text-red-700' // Sobrecarga üî¥
```

**Rangos:**
- **< 0.7 UG/ha**: Azul - Subcargado
- **0.7 - 1.5 UG/ha**: Verde - √ìptimo ‚úÖ
- **1.5 - 2.0 UG/ha**: Naranja - Alta
- **> 2.0 UG/ha**: Rojo - Sobrecarga

---

## üìä Relaci√≥n Lanar/Vacuno

En `/dashboard/lotes` tambi√©n se calcula:
```typescript
export function calcularRelacionLanarVacuno(lotes: Lote[]) {
  // Cuenta total de animales (no UG) de ovinos vs vacunos
  // Resultado: 1.5 significa "1.5 ovinos por cada 1 vacuno"
}
```

**Solo se muestra si hay AMBOS tipos en el campo.**

---

## üß™ Testing

Para verificar que todo funciona:

### **Test 1: Registro nuevo usuario**
```bash
# 1. Registr√° un usuario nuevo
# 2. Entr√° a /dashboard/lotes
# 3. Abr√≠ modal de Nacimiento
# ‚úÖ Deber√≠a ver "Terneros nacidos" y "Corderos/as Mamones"
```

### **Test 2: Usuarios existentes**
```bash
# 1. Corr√©s el script
npx tsx scripts/add-new-categorias.ts

# ‚úÖ Deber√≠a decir "Agregadas X categor√≠as nuevas"
```

### **Test 3: Crear categor√≠a custom**
```bash
# 1. Entr√° a /dashboard/preferencias
# 2. Cre√° "Vaquillas especiales"
# ‚úÖ Deber√≠a aparecer en modales inmediatamente
```

### **Test 4: Filtro en Datos**
```bash
# 1. Cre√° un nacimiento de "Terneros nacidos"
# 2. Entr√° a /dashboard/datos
# 3. Filtr√° por "Terneros nacidos"
# ‚úÖ Deber√≠a mostrar el evento de nacimiento
```

---

## üö® Troubleshooting

### Problema: "No aparecen categor√≠as en modales"
```
Causa: Usuario viejo sin categor√≠as en DB
Soluci√≥n: Correr npx tsx scripts/add-new-categorias.ts
```

### Problema: "UG mal calculadas"
```
Causa: Falta categor√≠a en EQUIVALENCIAS_UG
Soluci√≥n: Agregar en src/lib/ugCalculator.ts
```

### Problema: "Categor√≠a duplicada"
```
Causa: Se intent√≥ crear una que ya existe
Soluci√≥n: La API ya valida esto con skipDuplicates
```

### Problema: "Filtro no muestra eventos de una categor√≠a"
```
Causa 1: Categor√≠a est√° desactivada
Soluci√≥n: Activarla en /dashboard/preferencias

Causa 2: Falta en AGRUPACION_ANIMALES
Soluci√≥n: Agregar en src/app/contexts/DatosContext.tsx

Causa 3: El API no devuelve categoriaAnimal
Soluci√≥n: Verificar que /api/datos incluya: categoriaAnimal: evento.categoria
```

---

## üìù Resumen R√°pido

| Acci√≥n | D√≥nde |
|--------|-------|
| **Ver categor√≠as** | `constants.ts` (l√≠nea ~50) |
| **Agregar nueva** | `constants.ts` + `ugCalculator.ts` + script |
| **API GET** | `/api/categorias-animal` (se usa EN TODOS LADOS) |
| **API POST** | `/api/categorias-animal` (crear custom) |
| **C√°lculo UG** | `ugCalculator.ts` (l√≠nea ~10) |
| **Filtros Datos** | `DatosContext.tsx` (l√≠nea ~30) |
| **Script migraci√≥n** | `scripts/add-new-categorias.ts` |

---

## üéØ Checklist para Agregar Nueva Categor√≠a

- [ ] Agregar en `src/lib/constants.ts` ‚Üí CATEGORIAS_ANIMALES_DEFAULT
- [ ] Agregar equivalencia en `src/lib/ugCalculator.ts` ‚Üí EQUIVALENCIAS_UG
- [ ] Actualizar arrays en funciones de ugCalculator (calcularEstadisticas, calcularRelacion)
- [ ] (Opcional) Agregar en `src/app/contexts/DatosContext.tsx` ‚Üí AGRUPACION_ANIMALES
- [ ] Correr `npx tsx scripts/add-new-categorias.ts`
- [ ] Probar en modal de evento relevante
- [ ] Probar c√°lculo de UG en /dashboard/lotes
- [ ] Probar filtro en /dashboard/datos

---

## üéØ Conclusi√≥n

**NO BORRES `/api/categorias-animal`** - es el coraz√≥n del sistema de animales.

Para agregar categor√≠as nuevas:
1. ‚úèÔ∏è Edit√° `constants.ts` (agregar a array)
2. ‚úèÔ∏è Agreg√° equivalencia en `ugCalculator.ts` (3 lugares: EQUIVALENCIAS_UG + 2 funciones)
3. ‚úèÔ∏è (Opcional) Agreg√° en `DatosContext.tsx` (AGRUPACION_ANIMALES)
4. ‚ñ∂Ô∏è Corr√©s `npx tsx scripts/add-new-categorias.ts`

**Y listo** - nuevos y viejos usuarios tienen la categor√≠a disponible en todo el sistema. ‚úÖ