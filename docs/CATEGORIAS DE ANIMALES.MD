# üìã CATEGOR√çAS DE ANIMALES - Gu√≠a Completa

## üéØ ¬øQu√© son las Categor√≠as de Animales?

Las **Categor√≠as de Animales** son las clasificaciones que us√°s en todo el sistema para referirte a tipos espec√≠ficos de animales (Vacas, Toros, Novillos, Ovejas, etc.).

### ¬øPor qu√© son importantes?

1. **C√°lculo de UG (Unidades Ganaderas)**: Cada categor√≠a tiene una equivalencia espec√≠fica en UG
2. **Consistencia en el sistema**: Se usan en modales, reportes, filtros, estad√≠sticas
3. **Agrupaci√≥n**: Permiten agrupar animales por tipo en reportes y dashboards

---

## üèóÔ∏è Arquitectura del Sistema

### 1Ô∏è‚É£ **Definici√≥n Central** (`src/lib/constants.ts`)

```typescript
import { TipoAnimal } from '@prisma/client'

export const CATEGORIAS_ANIMALES_DEFAULT = [
  // BOVINOS
  { nombreSingular: 'Toros', nombrePlural: 'Toros', tipoAnimal: TipoAnimal.BOVINO },
  { nombreSingular: 'Vacas', nombrePlural: 'Vacas', tipoAnimal: TipoAnimal.BOVINO },
  // ... etc
]
```

**‚úÖ Este es el √öNICO lugar donde defin√≠s las categor√≠as predeterminadas.**

---

### 2Ô∏è‚É£ **Creaci√≥n Autom√°tica en Registro**

Cuando un usuario se registra (`/api/register`), se crean autom√°ticamente:

```typescript
// 4. Crear categor√≠as de animales predeterminadas
await tx.categoriaAnimal.createMany({
  data: CATEGORIAS_ANIMALES_DEFAULT.map(cat => ({
    nombreSingular: cat.nombreSingular,
    nombrePlural: cat.nombrePlural,
    tipoAnimal: cat.tipoAnimal,
    campoId: campo.id,
    activo: true,
    esPredeterminado: true,
  })),
})
```

**Resultado**: El nuevo usuario ya tiene las 21 categor√≠as en su campo.

---

### 3Ô∏è‚É£ **API de Gesti√≥n** (`/api/categorias-animal/route.ts`)

Esta API permite:

#### üìñ **GET** - Obtener categor√≠as de un campo

```typescript
// USO NORMAL (con sesi√≥n)
fetch('/api/categorias-animal')

// USO ESPECIAL (para SNIG, sin sesi√≥n)
fetch('/api/categorias-animal?campoId=xyz')
```

**D√≥nde se usa:**
- ‚úÖ **Modales** (Nacimiento, Mortandad, Recategorizaci√≥n, Venta, Compra, Consumo, etc.)
- ‚úÖ **SNIG** (necesita campoId por par√°metro porque no hay sesi√≥n)
- ‚úÖ **Filtros en Datos**
- ‚úÖ **Dropdowns en formularios**

#### ‚ûï **POST** - Crear categor√≠a personalizada

```typescript
fetch('/api/categorias-animal', {
  method: 'POST',
  body: JSON.stringify({
    nombreSingular: 'Vaquillas +1 a√±o',
    nombrePlural: 'Vaquillas +1 a√±o',
    tipoAnimal: 'BOVINO'
  })
})
```

**D√≥nde se usa:**
- ‚úÖ P√°gina de **Preferencias** (cuando el usuario crea una categor√≠a custom)

#### üîÑ **PATCH** - Activar/Desactivar categor√≠a

```typescript
fetch('/api/categorias-animal', {
  method: 'PATCH',
  body: JSON.stringify({
    id: 'abc123',
    activo: false
  })
})
```

**D√≥nde se usa:**
- ‚úÖ P√°gina de **Preferencias** (toggle on/off de categor√≠as)

---

## üî¢ C√°lculo de UG (Unidades Ganaderas)

### Archivo: `src/lib/ugCalculator.ts`

```typescript
export const EQUIVALENCIAS_UG: Record<string, number> = {
  // BOVINOS
  'Toros': 1.20,
  'Vacas': 1.00,
  'Novillos +3 a√±os': 1.00,
  'Terneros nacidos': 0.25,  // üëà NUEVA CATEGOR√çA
  // ... etc
}

export function calcularUGTotales(animales: Array<{ categoria: string; cantidad: number }>): number {
  return animales.reduce((total, animal) => {
    const equivalencia = EQUIVALENCIAS_UG[animal.categoria] || 0.8 // default si no existe
    return total + (animal.cantidad * equivalencia)
  }, 0)
}
```

**D√≥nde se usa:**
- ‚úÖ `/dashboard/lotes` - Carga global y por potrero
- ‚úÖ `/dashboard/indicadores` - Gr√°ficos de UG
- ‚úÖ `/dashboard/ug-evolution` - Evoluci√≥n hist√≥rica
- ‚úÖ `/api/dashboard-data` - Res√∫menes

---

## üìÇ Archivos que Usan Categor√≠as

### **Modales (todos en `/src/app/components/modales/`)**

| Modal | Uso |
|-------|-----|
| `ModalNacimiento.tsx` | Fetch categor√≠as ‚Üí dropdown "Categor√≠a de nacidos" |
| `ModalMortandad.tsx` | Fetch categor√≠as ‚Üí dropdown "Categor√≠a afectada" |
| `ModalRecategorizacion.tsx` | Fetch categor√≠as ‚Üí "De" y "A" |
| `ModalVenta.tsx` | Fetch categor√≠as ‚Üí renglones de venta |
| `ModalCompra.tsx` | Fetch categor√≠as ‚Üí renglones de compra |
| `ModalConsumo.tsx` | Fetch categor√≠as ‚Üí renglones de consumo |
| `ModalTacto.tsx` | Fetch categor√≠as ‚Üí dropdown |
| `ModalTratamiento.tsx` | Fetch categor√≠as ‚Üí dropdown |

**Patr√≥n com√∫n:**

```typescript
const { data: categorias = [] } = useSWR('/api/categorias-animal', fetcher)

// Luego en el dropdown:
<select>
  {categorias
    .filter(c => c.tipoAnimal === 'BOVINO' && c.activo)
    .map(cat => (
      <option key={cat.id} value={cat.nombreSingular}>
        {cat.nombreSingular}
      </option>
    ))
  }
</select>
```

---

### **P√°ginas**

| P√°gina | Uso |
|--------|-----|
| `/dashboard/lotes` | Fetch categor√≠as ‚Üí Agrupaci√≥n en badges |
| `/dashboard/datos` | Fetch categor√≠as ‚Üí Filtros de b√∫squeda |
| `/dashboard/indicadores` | Fetch categor√≠as ‚Üí Gr√°ficos por categor√≠a |
| `/dashboard/preferencias` | Fetch + POST + PATCH ‚Üí CRUD de categor√≠as |
| `/dashboard/snig` | Fetch con `?campoId=` ‚Üí Confirmar SNIG |

---

### **APIs**

| API | Uso |
|-----|-----|
| `/api/eventos` | Valida que la categor√≠a exista al crear evento |
| `/api/ventas` | Valida categor√≠as en renglones |
| `/api/compras` | Valida categor√≠as en renglones |
| `/api/consumos` | Valida categor√≠as en renglones |

---

## ‚ûï C√≥mo Agregar una Nueva Categor√≠a Predeterminada

### **Paso 1: Agregar en `constants.ts`**

```typescript
export const CATEGORIAS_ANIMALES_DEFAULT = [
  // ... categor√≠as existentes ...
  
  // üÜï NUEVA
  { 
    nombreSingular: 'Terneros destetados', 
    nombrePlural: 'Terneros destetados', 
    tipoAnimal: TipoAnimal.BOVINO 
  },
]
```

### **Paso 2: Agregar equivalencia UG en `ugCalculator.ts`**

```typescript
export const EQUIVALENCIAS_UG: Record<string, number> = {
  // ... equivalencias existentes ...
  
  // üÜï NUEVA
  'Terneros destetados': 0.50,
}
```

### **Paso 3: Correr script para usuarios existentes**

```bash
npx tsx scripts/add-new-categorias.ts
```

**‚úÖ LISTO** - Nuevos usuarios ya la tienen, usuarios viejos tambi√©n.

---

## üóëÔ∏è ¬øSe Puede Borrar `/api/categorias-animal`?

### ‚ùå **NO, ES CR√çTICO**

Esta API se usa en:

1. ‚úÖ **Todos los modales** (18+ componentes)
2. ‚úÖ **SNIG** (importaci√≥n de animales)
3. ‚úÖ **Preferencias** (CRUD de categor√≠as)
4. ‚úÖ **Filtros en Datos**
5. ‚úÖ **Validaci√≥n en APIs de eventos**

**Sin esta API, TODO el sistema de animales se rompe.**

---

## üîß C√≥mo Funciona el Sistema Completo

### **Flujo de Registro de Usuario Nuevo**

```
1. Usuario se registra ‚Üí /api/register
2. Se crea Campo ‚Üí campo.id = 'abc123'
3. Se crean 21 categor√≠as de animales con campoId = 'abc123'
4. Usuario entra al dashboard ‚Üí Fetch /api/categorias-animal
5. Aparecen en todos los dropdowns y modales
```

---

### **Flujo de Usuario Existente (antes del fix)**

```
1. Usuario ya existente ‚Üí NO ten√≠a categor√≠as en DB
2. Fetch /api/categorias-animal ‚Üí []
3. Modales no funcionaban (sin opciones)
4. Corrimos script ‚Üí add-new-categorias.ts
5. Ahora todos tienen las 21 categor√≠as
```

---

### **Flujo de C√°lculo de UG**

```
1. Usuario tiene animales en potrero:
   - 10 Vacas
   - 5 Terneros nacidos
   
2. Se llama calcularUGTotales([
     { categoria: 'Vacas', cantidad: 10 },
     { categoria: 'Terneros nacidos', cantidad: 5 }
   ])
   
3. Resultado:
   - 10 * 1.00 = 10.00 UG (Vacas)
   - 5 * 0.25 = 1.25 UG (Terneros nacidos)
   - TOTAL = 11.25 UG
   
4. Carga UG/ha:
   - Potrero tiene 10 hect√°reas
   - 11.25 UG / 10 ha = 1.13 UG/ha ‚úÖ Verde (√≥ptimo)
```

---

## üé® Colores de Carga UG

En `/dashboard/lotes` se muestra con colores:

```typescript
const color = 
  cargaUG < 0.7 ? 'bg-blue-100 text-blue-700'    // Baja
  : cargaUG <= 1.5 ? 'bg-green-100 text-green-700' // √ìptima ‚úÖ
  : cargaUG <= 2.0 ? 'bg-orange-100 text-orange-700' // Alta ‚ö†Ô∏è
  : 'bg-red-100 text-red-700' // Sobrecarga üî¥
```

**Rangos:**
- **< 0.7 UG/ha**: Azul - Subcargado
- **0.7 - 1.5 UG/ha**: Verde - √ìptimo ‚úÖ
- **1.5 - 2.0 UG/ha**: Naranja - Alta
- **> 2.0 UG/ha**: Rojo - Sobrecarga

---

## üìä Relaci√≥n Lanar/Vacuno

En `/dashboard/lotes` tambi√©n se calcula:

```typescript
export function calcularRelacionLanarVacuno(lotes: Lote[]) {
  // Cuenta UG de ovinos vs UG de vacunos
  // Resultado: 1.5 significa "1.5 UG de ovinos por cada 1 UG de vacunos"
}
```

**Solo se muestra si hay AMBOS tipos en el campo.**

---

## üß™ Testing

Para verificar que todo funciona:

### **Test 1: Registro nuevo usuario**
```bash
# Registr√° un usuario nuevo
# Entr√° a /dashboard/lotes
# ‚úÖ Deber√≠a ver categor√≠as en modales
```

### **Test 2: Usuarios existentes**
```bash
# Corr√©s el script
npx tsx scripts/add-new-categorias.ts

# ‚úÖ Deber√≠a decir "Agregadas X categor√≠as nuevas"
```

### **Test 3: Crear categor√≠a custom**
```bash
# Entr√° a /dashboard/preferencias
# Cre√° "Vaquillas especiales"
# ‚úÖ Deber√≠a aparecer en modales
```

---

## üö® Troubleshooting

### Problema: "No aparecen categor√≠as en modales"
```
Causa: Usuario viejo sin categor√≠as en DB
Soluci√≥n: Correr npx tsx scripts/add-new-categorias.ts
```

### Problema: "UG mal calculadas"
```
Causa: Falta categor√≠a en EQUIVALENCIAS_UG
Soluci√≥n: Agregar en src/lib/ugCalculator.ts
```

### Problema: "Categor√≠a duplicada"
```
Causa: Se intent√≥ crear una que ya existe
Soluci√≥n: La API ya valida esto con skipDuplicates
```

---

## üìù Resumen R√°pido

| Acci√≥n | D√≥nde |
|--------|-------|
| **Ver categor√≠as** | `constants.ts` |
| **Agregar nueva** | `constants.ts` + `ugCalculator.ts` + correr script |
| **API GET** | `/api/categorias-animal` (se usa EN TODOS LADOS) |
| **API POST** | `/api/categorias-animal` (crear custom) |
| **C√°lculo UG** | `ugCalculator.ts` |
| **Script migraci√≥n** | `scripts/add-new-categorias.ts` |

---

## üéØ Conclusi√≥n

**NO BORRES `/api/categorias-animal`** - es el coraz√≥n del sistema de animales.

Para agregar categor√≠as nuevas:
1. ‚úèÔ∏è Edit√° `constants.ts`
2. ‚úèÔ∏è Agreg√° equivalencia en `ugCalculator.ts`
3. ‚ñ∂Ô∏è Corr√©s `npx tsx scripts/add-new-categorias.ts`

**Y listo** - nuevos y viejos usuarios tienen la categor√≠a disponible en todo el sistema.